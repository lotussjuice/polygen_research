<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Contenido de Datos CRF</title>
</head>

<body>
    
<div th:fragment="contenido">

    <style>
        /* Estilos para el botón '+' y los tags de criterios */
        .btn-add-criterion {
            font-weight: bold;
            padding: 0px 6px;
            line-height: 1;
            margin-left: 8px;
            font-size: 0.8em;
            border-radius: 50%;
            border: 1px solid var(--color-principal, #007bff);
            background-color: var(--color-fondo-claro, #f8f9fa);
            color: var(--color-principal, #007bff);
        }
        .criterion-tag {
            display: inline-block;
            font-size: 0.75em;
            background-color: var(--color-principal-claro, #e0e0e0);
            color: var(--color-texto, #333);
            border-radius: 4px;
            padding: 2px 5px;
            margin-top: 4px;
            margin-right: 4px;
        }
        .criterion-tag .btn-remove {
            border: none;
            background: none;
            padding: 0 0 0 5px;
            color: red;
            font-weight: bold;
        }
        .table-responsive-wrapper { overflow-x: auto; }
        
        /* Por mientras esta linea nos sirve para que se vea bien. Al modificar, quitenla
        */
        @import url('https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css');
        
    </style>


    <div class="card">
        <div class="card-header">
            <h3><i class="ph-bold ph-chart-line"></i> Reporte de Datos (Valores CRF)</h3>
        </div>
        <div class="card-body">
            <p>Cada fila representa un CRF completo. Use (+) para añadir criterios de dicotomización antes de exportar.</p>

            <form id="exportForm" th:action="@{/datos-crf/list/exportar}" method="post">
                <input type="hidden" id="criteriosExport" name="criteriosJson" />
                <button type="submit" class="btn btn-success mb-3">
                    <i class="ph-bold ph-file-xls"></i> Exportar a Excel
                </button>
            </form>

            <div th:if="${#lists.isEmpty(filasCrf)}" class="alert" style="background-color: var(--color-fondo); color: var(--color-texto-secundario);">
                No se han encontrado CRFs para mostrar en el reporte.
            </div>

            <div class="table-responsive-wrapper" th:if="${!#lists.isEmpty(filasCrf)}">
                <table>
                    <thead>
                        <tr>
                            <th>ID CRF</th>
                            <th>Cód. Paciente</th>
                            <th>Paciente</th>
                            <th>Fecha Creación</th>
                            <th th:each="campo : ${camposColumnas}">
                                <div class="d-flex align-items-center">
                                    <span th:text="${campo.nombre}">...</span>
                                    <button th:if="${campo.tipo == 'NUMERO'}" 
                                            type="button" 
                                            class="btn-add-criterion"
                                            th:data-campo-id="${campo.idCampo}"
                                            th:data-campo-nombre="${campo.nombre}">
                                        +
                                    </button>
                                </div>
                                <div class="criteria-tags" th:id="'tags-campo-' + ${campo.idCampo}"></div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="fila : ${filasCrf}">
                            <td th:text="${fila.crf.idCrf}">...</td>
                            <td th:text="${fila.crf.datosPaciente?.codigoPaciente}">...</td>
                            <td th:text="${fila.crf.datosPaciente?.nombre + ' ' + fila.crf.datosPaciente?.apellido}">...</td>
                            <td th:text="${fila.crf.fechaConsulta != null ? #temporals.format(fila.crf.fechaConsulta, 'dd/MM/yyyy') : 'N/A'}">...</td>
                            <td th:each="campo : ${camposColumnas}">
                                <span th:text="${fila.valores.get(campo.idCampo) ?: '-'}"></span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCriterio" tabindex="-1" aria-labelledby="modalCriterioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCriterioLabel">Agregar Criterio para: <span id="modalCampoNombre"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalCampoId" />
                    <div class="mb-3">
                        <label for="selectTipoCriterio" class="form-label">Tipo de Criterio</label>
                        <select class="form-select" id="selectTipoCriterio">
                            <option value="media">Media</option>
                            <option value="mediana">Mediana</option>
                            <option value="promedio">Promedio</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                    </div>
                    <div id="divPersonalizado" style="display: none;">
                        <div class="mb-3">
                            <label for="inputNombreCriterio" class="form-label">Nombre para la Columna Excel</label>
                            <input type="text" class="form-control" id="inputNombreCriterio" placeholder="Ej: Edad_Joven">
                            <small>Se usará como cabecera en Excel (Ej: Edad_Joven)</small>
                        </div>
                        <div class="mb-3">
                            <label for="inputPuntoCorte" class="form-label">Punto de Corte (Valor numérico)</label>
                            <input type="number" class="form-control" id="inputPuntoCorte" placeholder="Ej: 30">
                        </div>
                        <div class="mb-3">
                            <label for="selectOperador" class="form-label">Operador</label>
                            <select class="form-select" id="selectOperador">
                                <option value="<">&lt; (Menor que)</option>
                                <option value="<=">&lt;= (Menor o igual que)</option>
                                <option value=">">&gt; (Mayor que)</option>
                                <option value=">=">&gt;= (Mayor o igual que)</option>
                                <option value="==">== (Igual a)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarCriterio">Guardar Criterio</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Espera a que todo el HTML esté cargado
        document.addEventListener('DOMContentLoaded', () => {
        
            // 1. Objeto global para guardar los criterios
            let criterios = {};
        
            // 2. Referencias a los elementos del DOM
            const modalElement = document.getElementById('modalCriterio');
            
            // ¡IMPORTANTE! Si tu layout no carga el JS de Bootstrap, esto fallará.
            if (typeof bootstrap === 'undefined' || typeof bootstrap.Modal === 'undefined') {
                console.error("Error: El JavaScript de Bootstrap no está cargado. El modal de criterios no funcionará.");
                // Intenta cargar el script dinámicamente si no existe
                if (!document.querySelector('script[src*="bootstrap.bundle.min.js"]')) {
                    let script = document.createElement('script');
                    script.src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js";
                    script.onload = inicializarModal; // Llama a la inicialización después de cargar
                    document.body.appendChild(script);
                }
            } else {
                inicializarModal(); // Carga normal si Bootstrap ya existe
            }

            let modalCriterio;
            const modalCampoId = document.getElementById('modalCampoId');
            const modalCampoNombre = document.getElementById('modalCampoNombre');
            const selectTipoCriterio = document.getElementById('selectTipoCriterio');
            const divPersonalizado = document.getElementById('divPersonalizado');
            const inputNombreCriterio = document.getElementById('inputNombreCriterio');
            const inputPuntoCorte = document.getElementById('inputPuntoCorte');
            const selectOperador = document.getElementById('selectOperador');
            const btnGuardarCriterio = document.getElementById('btnGuardarCriterio');
            const exportForm = document.getElementById('exportForm');
            
            function inicializarModal() {
                 if (!modalElement) {
                    console.error("No se encontró #modalCriterio");
                    return;
                }
                modalCriterio = new bootstrap.Modal(modalElement);

                // 5. Guardar Criterio desde el Modal
                btnGuardarCriterio.addEventListener('click', () => {
                    const campoId = parseInt(modalCampoId.value, 10);
                    const tipo = selectTipoCriterio.value;
                    
                    let criterioNuevo = { tipo: tipo };

                    if (tipo === 'personalizado') {
                        const nombre = inputNombreCriterio.value.trim();
                        const corte = inputPuntoCorte.value.trim();
                        const operador = selectOperador.value;

                        if (!nombre || !corte) {
                            alert('Para criterio personalizado, debe ingresar un nombre y un punto de corte.');
                            return;
                        }
                        criterioNuevo.nombre = nombre;
                        criterioNuevo.puntoCorte = `${operador}${corte}`; 
                    }

                    if (!criterios[campoId]) {
                        criterios[campoId] = [];
                    }

                    criterios[campoId].push(criterioNuevo);
                    actualizarTagsUI();
                    modalCriterio.hide();
                });
            }

            // 3. Mostrar/Ocultar campos de "Personalizado"
            selectTipoCriterio.addEventListener('change', () => {
                divPersonalizado.style.display = (selectTipoCriterio.value === 'personalizado') ? 'block' : 'none';
            });
        
            // 4. Abrir el Modal al hacer clic en '+'
            document.querySelectorAll('.btn-add-criterion').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (!modalCriterio) {
                        console.error("El modal no está inicializado. ¿Falta el JS de Bootstrap?");
                        alert("Error: No se pudo abrir el modal. Revise la consola.");
                        return;
                    }
                    const campoId = e.target.dataset.campoId;
                    const campoNombre = e.target.dataset.campoNombre;
                    
                    modalCampoId.value = campoId;
                    modalCampoNombre.textContent = campoNombre;
                    selectTipoCriterio.value = 'media';
                    divPersonalizado.style.display = 'none';
                    inputNombreCriterio.value = '';
                    inputPuntoCorte.value = '';
                    
                    modalCriterio.show();
                });
            });
        
            // 6. Función para dibujar los 'tags' de criterios
            function actualizarTagsUI() {
                document.querySelectorAll('.criteria-tags').forEach(div => div.innerHTML = '');
        
                for (const campoId in criterios) {
                    const container = document.getElementById(`tags-campo-${campoId}`);
                    if (container) {
                        criterios[campoId].forEach((crit, index) => {
                            let nombreTag = crit.tipo;
                            if (crit.tipo === 'personalizado') {
                                nombreTag = crit.nombre;
                            }
        
                            const tag = document.createElement('span');
                            tag.className = 'criterion-tag';
                            tag.textContent = nombreTag;
                            
                            const btnRemove = document.createElement('button');
                            btnRemove.type = 'button';
                            btnRemove.className = 'btn-remove';
                            btnRemove.innerHTML = '&times;';
                            btnRemove.dataset.campoId = campoId;
                            btnRemove.dataset.index = index; 
                            
                            tag.appendChild(btnRemove);
                            container.appendChild(tag);
                        });
                    }
                }
            }
        
            // 7. Event Listener para borrar un 'tag'
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-remove')) {
                    const campoId = e.target.dataset.campoId;
                    const index = e.target.dataset.index;
                    
                    criterios[campoId].splice(index, 1);
                    actualizarTagsUI();
                }
            });
        
            // 8. Interceptar el 'submit' del formulario de exportación
            exportForm.addEventListener('submit', (e) => {
                const jsonCriterios = JSON.stringify(criterios);
                document.getElementById('criteriosExport').value = jsonCriterios;
            });
        });
    </script>

</div> </body>
</html>
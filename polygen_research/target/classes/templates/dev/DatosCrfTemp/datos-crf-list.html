<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main-layout :: ~{}}">

<body>
    <div th:fragment="contenido">

        <div class="card">
            <div class="card-header">
                <h3><i class="ph-bold ph-chart-line"></i> Reporte de Datos (Valores CRF)</h3>

                <form th:action="@{/datos-crf/list}" method="get"
                    style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" name="codigoPaciente" class="form-control"
                        placeholder="Buscar por Cód. Paciente..." th:value="${param.codigoPaciente}" />
                    <button type="submit" class="btn-primario btn-sm">Buscar</button> <a th:href="@{/datos-crf/list}"
                        class="btn-secundario btn-sm" title="Limpiar búsqueda">Limpiar</a>
                </form>

            </div>
            <div class="card-body">

                <p>Cada fila representa un CRF completo. Use (+) en las columnas numéricas para añadir criterios de
                    dicotomización antes de exportar.</p>
                <br>

                <div
                    style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">

                    <div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" id="btn-excel-confirm" class="btn-sm btn-chart-2"
                                title="Descargar Excel">
                                <i class="ph-bold ph-file-xls"></i> Exportar a Excel
                            </button>

                            <button type="button" id="btn-stata-preview" class="btn-sm btn-chart-1"
                                style="margin-left: 0.5rem;" title="Exportar para STATA">
                                <i class="ph-bold ph-file"></i> Exportar para STATA
                            </button>
                        </div>

                        <form id="exportForm" th:action="@{/datos-crf/list/exportar}" method="post"
                            style="display: none;">
                            <input type="hidden" id="criteriosExport" name="criteriosJson" />
                        </form>

                        <form id="stataExportForm" th:action="@{/datos-crf/list/exportar-stata}" method="post"
                            style="display: none;">
                            <input type="hidden" id="stataCriteriosExport" name="criteriosJson" />
                        </form>
                    </div>

                    <div th:if="${#lists.isEmpty(filasCrf)}" class="alert"
                        style="background-color: var(--color-fondo); color: var(--color-texto-secundario);">
                        No se han encontrado CRFs para mostrar en el reporte.
                    </div>

                    <div class="table-responsive-wrapper" th:if="${!#lists.isEmpty(filasCrf)}">
                        <table class="tabla-bonita">
                            <thead>
                                <tr>
                                    <th>Cód. Paciente</th>

                                    <th th:each="campoStat : ${camposColumnas}"
                                        th:title="${campoStat.opcion != null ? campoStat.campoCrf.nombre : (campoStat.campoCrf.descripcion ?: campoStat.campoCrf.nombre)}">

                                        <div
                                            style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                            <span
                                                th:text="${campoStat.opcion != null ? campoStat.opcion.etiqueta : campoStat.campoCrf.nombre}">...</span>

                                            <button
                                                th:if="${#strings.equalsIgnoreCase(campoStat.campoCrf.tipo, 'NUMERO')}"
                                                type="button" class="btn-add-criterion"
                                                th:data-campo-id="${campoStat.campoCrf.idCampo}"
                                                th:data-campo-nombre="${campoStat.campoCrf.nombre}">
                                                +
                                            </button>
                                        </div>
                                        <div class="criteria-tags" th:id="'tags-campo-' + ${campoStat.campoCrf.idCampo}"
                                            style="justify-content: center;"></div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="fila : ${filasCrf}">
                                    <td th:text="${fila.crf.datosPaciente?.codigoPaciente}">...</td>

                                    <td th:each="campoStat : ${camposColumnas}">
                                        <span th:text="${fila.valores.get(campoStat.columnaKey) ?: '-'}"></span>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Total Vacíos:</td>
                                    <td th:each="stat : ${camposColumnas}" th:text="${stat.countVacios}">...</td>
                                </tr>
                                <tr>
                                    <td>Total Ceros (0):</td>
                                    <td th:each="stat : ${camposColumnas}" th:text="${stat.countCeros}">...</td>
                                </tr>
                                <tr>
                                    <td>Total Unos (1):</td>
                                    <td th:each="stat : ${camposColumnas}" th:text="${stat.countUnos}">...</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="modal fade" id="modalCriterio" tabindex="-1" aria-labelledby="modalCriterioLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content"
                                style="background-color: var(--color-tarjeta); color: var(--color-texto); border-color: var(--color-borde); max-width: 500px;">
                                <div class="modal-header" style="border-bottom-color: var(--color-borde);">
                                    <h5 class="modal-title" id="modalCriterioLabel">Agregar Criterio: <span
                                            id="modalCampoNombre"></span></h5>
                                    <button type="button" class="close-modal" data-bs-dismiss="modal">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" id="modalCampoId" />
                                    <div class="form-group">
                                        <label>Tipo de Criterio</label>
                                        <select class="form-control" id="selectTipoCriterio">
                                            <option value="media">Media</option>
                                            <option value="mediana">Mediana</option>
                                            <option value="promedio">Promedio</option>
                                            <option value="personalizado">Personalizado</option>
                                        </select>
                                    </div>
                                    <div id="divPersonalizado" style="display: none;">
                                        <div class="form-group">
                                            <label>Nombre Columna Excel</label>
                                            <input type="text" class="form-control" id="inputNombreCriterio"
                                                placeholder="Ej: Edad_Joven">
                                        </div>
                                        <div class="form-group">
                                            <label>Punto de Corte</label>
                                            <input type="number" class="form-control" id="inputPuntoCorte"
                                                placeholder="Ej: 30">
                                        </div>
                                        <div class="form-group">
                                            <label>Operador</label>
                                            <select class="form-control" id="selectOperador">
                                                <option value="<">&lt; (Menor que)</option>
                                                <option value="<=">&lt;= (Menor o igual que)</option>
                                                <option value=">">&gt; (Mayor que)</option>
                                                <option value=">=">&gt;= (Mayor o igual que)</option>
                                                <option value="==">== (Igual a)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer" style="border-top-color: var(--color-borde);">
                                    <div class="btn-group-equal">
                                        <button type="button" class="btn-secundario"
                                            data-bs-dismiss="modal">Cancelar</button>
                                        <button type="button" class="btn-primario"
                                            id="btnGuardarCriterio">Guardar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalExcelConfirm" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content"
                                style="max-width: 450px; text-align: center; background-color: var(--color-tarjeta); color: var(--color-texto); border-color: var(--color-borde);">
                                <div class="modal-header" style="justify-content: center; border-bottom: none;">
                                    <div style="background-color: #f0fff4; padding: 1rem; border-radius: 50%;">
                                        <i class="ph-bold ph-file-xls"
                                            style="font-size: 2.5rem; color: var(--color-exito);"></i>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <h2 style="margin-bottom: 1rem;">¿Exportar a Excel?</h2>
                                    <div style="margin-top: 1rem; text-align: left;">
                                        <strong style="font-size: 0.9rem;">Dicotomizaciones a incluir:</strong>
                                        <div id="excel-dicotom-list"
                                            style="margin-top: 0.5rem; padding: 0.8rem; background-color: var(--color-fondo); border-radius: 6px; max-height: 150px; overflow-y: auto; font-size: 0.85rem;">
                                            <em style="color: var(--color-texto-secundario);">Calculando...</em>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer" style="justify-content: center; border-top: none;">
                                    <div class="btn-group-equal" style="display: flex; gap: 10px; width: 100%;">
                                        <button type="button" class="btn-secundario" data-bs-dismiss="modal"
                                            style="flex: 1;">Cancelar</button>
                                        <button type="button" class="btn-exito" id="btn-execute-excel"
                                            style="flex: 1;">Descargar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalStataPreview" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content"
                                style="max-width: 500px; text-align: center; background-color: var(--color-tarjeta); color: var(--color-texto); border-color: var(--color-borde);">
                                <div class="modal-header" style="justify-content: center; border-bottom: none;">
                                    <div style="background-color: #eef4fc; padding: 1rem; border-radius: 50%;">
                                        <i class="ph-bold ph-file-code"
                                            style="font-size: 2.5rem; color: var(--color-primario);"></i>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <h2 style="margin-bottom: 1rem;">Formato STATA</h2>
                                    <div style="text-align: left;">
                                        <strong style="font-size: 0.9rem;">Dicotomizaciones a incluir:</strong>
                                        <div id="stata-dicotom-list"
                                            style="margin-top: 0.5rem; padding: 0.8rem; background-color: var(--color-fondo); border-radius: 6px; max-height: 150px; overflow-y: auto; font-size: 0.85rem;">
                                            <em style="color: var(--color-texto-secundario);">Ninguna.</em>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer" style="justify-content: center; border-top: none;">
                                    <div class="btn-group-equal" style="display: flex; gap: 10px; width: 100%;">
                                        <button type="button" class="btn-secundario" data-bs-dismiss="modal"
                                            style="flex: 1;">Cancelar</button>
                                        <button type="button" class="btn-stata" id="btn-confirmar-descarga-stata"
                                            style="flex: 1;">Exportar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            let criterios = {};
                            const modalCriterioEl = document.getElementById('modalCriterio');
                            const modalStataEl = document.getElementById('modalStataPreview');
                            const modalExcelEl = document.getElementById('modalExcelConfirm');

                            if (typeof bootstrap === 'undefined' || typeof bootstrap.Modal === 'undefined') {
                                if (!document.querySelector('script[src*="bootstrap.bundle.min.js"]')) {
                                    let script = document.createElement('script');
                                    script.src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js";
                                    script.crossOrigin = "anonymous";
                                    script.onload = inicializarModales;
                                    document.body.appendChild(script);
                                } else { inicializarModales(); }
                            } else { inicializarModales(); }

                            let bsModalCriterio, bsModalStata, bsModalExcel;
                            const modalCampoId = document.getElementById('modalCampoId');
                            const modalCampoNombre = document.getElementById('modalCampoNombre');
                            const selectTipo = document.getElementById('selectTipoCriterio');
                            const divPersonalizado = document.getElementById('divPersonalizado');
                            const inputNombre = document.getElementById('inputNombreCriterio');
                            const inputCorte = document.getElementById('inputPuntoCorte');
                            const selectOperador = document.getElementById('selectOperador');
                            const btnGuardarCriterio = document.getElementById('btnGuardarCriterio');
                            const btnExcelConfirm = document.getElementById('btn-excel-confirm');
                            const btnExecuteExcel = document.getElementById('btn-execute-excel');
                            const btnStataPreview = document.getElementById('btn-stata-preview');
                            const btnExecuteStata = document.getElementById('btn-confirmar-descarga-stata');
                            const excelForm = document.getElementById('exportForm');
                            const excelInput = document.getElementById('criteriosExport');
                            const excelListContainer = document.getElementById('excel-dicotom-list');
                            const stataForm = document.getElementById('stataExportForm');
                            const stataInput = document.getElementById('stataCriteriosExport');
                            const stataListContainer = document.getElementById('stata-dicotom-list');

                            function inicializarModales() {
                                if (typeof bootstrap === 'undefined') return;
                                if (modalCriterioEl) bsModalCriterio = new bootstrap.Modal(modalCriterioEl);
                                if (modalStataEl) bsModalStata = new bootstrap.Modal(modalStataEl);
                                if (modalExcelEl) bsModalExcel = new bootstrap.Modal(modalExcelEl);
                                if (btnGuardarCriterio) btnGuardarCriterio.onclick = guardarCriterioAction;
                            }

                            function guardarCriterioAction() {
                                const id = parseInt(modalCampoId.value, 10);
                                const nombreCampo = modalCampoNombre.textContent;
                                const tipo = selectTipo.value;
                                let nuevo = { tipo: tipo, campoNombre: nombreCampo };
                                if (tipo === 'personalizado') {
                                    const nom = inputNombre.value.trim();
                                    const val = inputCorte.value.trim();
                                    const op = selectOperador.value;
                                    if (!nom || !val) { alert('Complete los campos.'); return; }
                                    nuevo.nombre = nom; nuevo.puntoCorte = `${op}${val}`;
                                }
                                if (!criterios[id]) criterios[id] = [];
                                criterios[id].push(nuevo);
                                actualizarTags();
                                if (bsModalCriterio) bsModalCriterio.hide();
                            }

                            if (selectTipo) selectTipo.addEventListener('change', () => divPersonalizado.style.display = (selectTipo.value === 'personalizado') ? 'block' : 'none');

                            document.querySelectorAll('.btn-add-criterion').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    if (!bsModalCriterio) return;
                                    modalCampoId.value = e.target.dataset.campoId;
                                    modalCampoNombre.textContent = e.target.dataset.campoNombre;
                                    selectTipo.value = 'media'; divPersonalizado.style.display = 'none';
                                    inputNombre.value = ''; inputCorte.value = '';
                                    bsModalCriterio.show();
                                });
                            });

                            function actualizarTags() {
                                document.querySelectorAll('.criteria-tags').forEach(div => div.innerHTML = '');
                                for (const id in criterios) {
                                    const container = document.getElementById(`tags-campo-${id}`);
                                    if (container) {
                                        criterios[id].forEach((c, idx) => {
                                            let texto = c.tipo;
                                            if (c.tipo === 'personalizado') texto = `${c.nombre} (${c.puntoCorte})`;
                                            const tag = document.createElement('span'); tag.className = 'criterion-tag';
                                            tag.innerHTML = `${texto} <button type="button" class="btn-remove" data-id="${id}" data-idx="${idx}">&times;</button>`;
                                            container.appendChild(tag);
                                        });
                                    }
                                }
                            }

                            document.body.addEventListener('click', (e) => {
                                if (e.target.classList.contains('btn-remove')) {
                                    const id = e.target.dataset.id; const idx = e.target.dataset.idx;
                                    if (criterios[id]) { criterios[id].splice(idx, 1); if (criterios[id].length === 0) delete criterios[id]; actualizarTags(); }
                                }
                            });

                            function generarListaHtml() {
                                let html = '<ul style="padding-left: 1rem; margin: 0;">'; let hay = false;
                                for (let id in criterios) {
                                    if (criterios[id].length > 0) {
                                        hay = true;
                                        criterios[id].forEach(c => {
                                            let desc = c.tipo === 'personalizado' ? `<strong>${c.nombre}</strong> (Corte: ${c.puntoCorte})` : `<strong>${c.tipo.charAt(0).toUpperCase() + c.tipo.slice(1)}</strong>`;
                                            html += `<li style="margin-bottom: 4px;">${c.campoNombre}: ${desc}</li>`;
                                        });
                                    }
                                }
                                html += '</ul>';
                                return hay ? html : '<em style="color: var(--color-texto-secundario);">Ninguna. Se exportarán los datos crudos.</em>';
                            }

                            if (btnExcelConfirm) btnExcelConfirm.addEventListener('click', () => { if (bsModalExcel) { excelListContainer.innerHTML = generarListaHtml(); bsModalExcel.show(); } });
                            if (btnExecuteExcel) btnExecuteExcel.addEventListener('click', () => { excelInput.value = JSON.stringify(criterios); excelForm.submit(); bsModalExcel.hide(); });
                            if (btnStataPreview) btnStataPreview.addEventListener('click', () => { if (bsModalStata) { stataListContainer.innerHTML = generarListaHtml(); bsModalStata.show(); } });
                            if (btnExecuteStata) btnExecuteStata.addEventListener('click', () => { stataInput.value = JSON.stringify(criterios); stataForm.submit(); bsModalStata.hide(); });
                        });
                    </script>
                </div>
</body>

</html>
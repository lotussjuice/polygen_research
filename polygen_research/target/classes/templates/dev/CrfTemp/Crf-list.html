<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security6"
    th:replace="~{layout/main-layout :: ~{}}">

<head>
</head>

<body>

    <div th:fragment="contenido">

        <div class="card">
            <div class="card-header">
                <h3><i class="ph-bold ph-table"></i> Gestión de CRFs</h3>

                <div style="display: flex; align-items: center; gap: 1rem;">

                    <form th:action="@{/crf/list}" method="get"
                        style="display: flex; gap: 0.5rem; align-items: center;">

                        <input type="text" name="codigoPaciente" class="form-control"
                            placeholder="Buscar por Cód. Paciente..." th:value="${param.codigoPaciente}" />

                        <button type="submit" class="btn-primario">Buscar</button>

                        <div
                            style="display: flex; align-items: center; margin-left: 1rem; background: var(--color-fondo); padding: 0.4rem 0.8rem; border-radius: 8px; border: 1px solid var(--color-borde);">

                            <label class="switch" style="margin-right: 0.5rem; margin-bottom: 0;">
                                <input type="checkbox" name="ocultarInactivos" th:checked="${ocultarInactivos}"
                                    onchange="this.form.submit()">

                                <span class="slider slider-clean"></span>
                            </label>

                            <span style="font-size: 0.9rem; color: var(--color-texto);">Ocultar Inactivos</span>
                        </div>

                        <a th:href="@{/crf/list}" class="btn-secundario" title="Limpiar búsqueda y filtros">Limpiar</a>
                    </form>
                </div>

                <a th:href="@{/crf/nuevo}" class="btn-primario btn-sm">
                    <i class="ph-bold ph-plus"></i> Agregar Nuevo CRF
                </a>
            </div>

            <div class="card-body">
                <p>Listado completo de todos los CRFs registrados.</p>

                <div th:if="${#lists.isEmpty(filasCrf)}" class="alert"
                    style="background-color: var(--color-fondo); color: var(--color-texto-secundario);">
                    No se han encontrado CRFs para mostrar.
                </div>

                <div class="table-responsive-wrapper" th:if="${!#lists.isEmpty(filasCrf)}">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 140px; text-align: center;">Acciones</th>

                                <th>Fecha Creación</th>
                                <th>Cód. Paciente</th>
                                <th>Nombre Paciente</th>
                                <th>Apellido Paciente</th>
                                <th>Número</th>
                                <th>Dirección</th>
                                <th>Estado Paciente</th>

                                <th th:each="campoStat : ${camposColumnas}" th:text="${campoStat.campoCrf.nombre}">...
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="fila : ${filasCrf}" th:id="'row-crf-' + ${fila.crf.idCrf}"
                                th:classappend="${fila.crf.datosPaciente?.estado != 'ACTIVO'} ? 'row-inactive' : ''">

                                <td class="actions-cell" style="white-space: nowrap;">
                                    <div style="display: flex; justify-content: center; gap: 8px; align-items: center;">

                                        <button type="button" class="btn-secundario btn-sm"
                                            th:onclick="|verDetalleCrf(${fila.crf.idCrf})|"
                                            title="Ver Detalle Completo">
                                            <i class="ph-bold ph-eye"></i>
                                        </button>

                                        <button type="button" class="btn-secundario btn-sm"
                                            th:onclick="|verDatosFaltantes(${fila.crf.idCrf})|"
                                            title="Ver Datos Faltantes" style="position: relative;"> <i
                                                class="ph-bold ph-list-checks"></i>

                                            <span
                                                th:if="${fila.datosFaltantes > 0 and fila.crf.datosPaciente?.estado == 'ACTIVO'}"
                                                class="warning-dot-floating" title="CRF Incompleto"
                                                style="top: -3px; right: -3px; left: auto;"> </span>
                                        </button>

                                        <a th:href="@{/crf/pdf/{id}(id=${fila.crf.idCrf})}"
                                            class="btn btn-sm btn-outline-danger" title="Descargar PDF" target="_blank"
                                            style="padding: 0.3rem 0.6rem; text-decoration: none; display: inline-flex; align-items: center;">
                                            <i class="ph-bold ph-file-pdf"></i>
                                        </a>

                                        <a th:href="@{/crf/editar/{id}(id=${fila.crf.idCrf})}"
                                            class="btn-secundario btn-sm" title="Editar CRF"
                                            style="display: inline-flex; align-items: center;">
                                            <i class="ph-bold ph-pencil-simple"></i>
                                        </a>

                                        <button type="button" class="btn-error btn-sm"
                                            th:attr="data-crf-id=${fila.crf.idCrf}" onclick="confirmarEliminarCRF(this)"
                                            title="Eliminar CRF">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                    </div>
                                </td>

                                <td
                                    th:text="${fila.crf.fechaConsulta != null ? #temporals.format(fila.crf.fechaConsulta, 'dd/MM/yyyy') : 'N/A'}">
                                    ...</td>
                                <td th:text="${fila.crf.datosPaciente?.codigoPaciente ?: '-'}">...</td>
                                <td th:text="${fila.crf.datosPaciente?.nombre ?: '-'}">...</td>
                                <td th:text="${fila.crf.datosPaciente?.apellido ?: '-'}">...</td>
                                <td th:text="${fila.crf.datosPaciente?.numero ?: '-'}">...</td>
                                <td th:text="${fila.crf.datosPaciente?.direccion ?: '-'}">...</td>

                                <td th:text="${fila.crf.datosPaciente?.estado ?: '-'}">...</td>

                                <td th:each="campoStat : ${camposColumnas}">
                                    <span th:text="${fila.valores.get(campoStat.columnaKey) ?: '-'}"></span>
                                </td>

                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="modalConfirmacionEliminarCRF" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Confirmar Eliminación</h2>
                    <span class="close-modal" onclick="cerrarConfirmacionEliminarCRF()">&times;</span>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar permanentemente el CRF con ID <strong
                            id="confirm-crf-id-text"></strong>?</p>
                    <p style="color: var(--color-error); font-weight: bold;">Esta acción no se puede deshacer y
                        eliminará todos los datos asociados.</p>
                    <input type="hidden" id="confirm-crf-id" value="" />
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <button type="button" class="btn-secundario"
                        onclick="cerrarConfirmacionEliminarCRF()">Cancelar</button>
                    <button type="button" class="btn-error" onclick="ejecutarEliminacionCRF()">Sí, Eliminar CRF</button>
                </div>
            </div>
        </div>

        <div id="modalDatosFaltantes" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 id="modal-faltantes-titulo">Datos Faltantes</h2>
                    <span class="close-modal" onclick="cerrarModalDatosFaltantes()">&times;</span>
                </div>
                <div class="modal-body" id="modal-faltantes-body"
                    style="padding-top: 1rem; max-height: 400px; overflow-y: auto;">
                    <p>Cargando...</p>
                </div>
            </div>
        </div>

        <div id="modalVerDetalle" class="modal" style="display: none;">
            <div class="modal-content"
                style="max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">

                <div class="modal-header" style="flex-shrink: 0;">
                    <h2><i class="ph-bold ph-file-text"></i> Detalle CRF</h2>
                    <span id="detalle-id-titulo" style="display: none;"></span>
                    <span class="close-modal" onclick="cerrarModalDetalle()">&times;</span>
                </div>

                <div class="modal-body" style="overflow-y: auto; padding: 1.5rem;">

                    <div class="detail-section"
                        style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                        <h4 style="color: var(--color-primario); margin-bottom: 0.5rem;">Paciente</h4>
                        <p><strong>Código:</strong> <span id="detalle-codigo"></span></p>
                        <p><strong>Nombre:</strong> <span id="detalle-nombre"></span></p>
                        <p><strong>Fecha Consulta:</strong> <span id="detalle-fecha"></span></p>
                        <p><strong>Tipo Estudio:</strong> <span id="detalle-tipo"></span></p>
                    </div>

                    <div class="detail-section"
                        style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                        <h4 style="color: var(--color-primario); margin-bottom: 0.5rem;">Observaciones</h4>
                        <p id="detalle-obs"
                            style="white-space: pre-wrap; font-style: italic; color: var(--color-texto-secundario);">
                        </p>
                    </div>

                    <div class="detail-section">
                        <h4 style="color: var(--color-primario); margin-bottom: 1rem;">Datos Clínicos</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tbody id="detalle-tabla-cuerpo">
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>
        </div>

        <th:block th:fragment="pageScript">
            <script th:inline="javascript">
                const modalConfirmacionCRF = document.getElementById('modalConfirmacionEliminarCRF');
                const confirmCrfIdText = document.getElementById('confirm-crf-id-text');
                const confirmCrfIdInput = document.getElementById('confirm-crf-id');
                const modalDatosFaltantes = document.getElementById('modalDatosFaltantes');
                const modalVerDetalle = document.getElementById('modalVerDetalle');
                const slider = document.querySelector('.table-responsive-wrapper');

                function confirmarEliminarCRF(button) {
                    const crfId = button.getAttribute('data-crf-id');
                    confirmCrfIdText.textContent = crfId;
                    confirmCrfIdInput.value = crfId;
                    if (modalConfirmacionCRF) modalConfirmacionCRF.style.display = 'block';
                }

                function cerrarConfirmacionEliminarCRF() {
                    if (modalConfirmacionCRF) modalConfirmacionCRF.style.display = 'none';
                    confirmCrfIdText.textContent = '';
                    confirmCrfIdInput.value = '';
                }

                async function ejecutarEliminacionCRF() {
                    const crfId = confirmCrfIdInput.value;
                    if (!crfId) return;

                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                    const headers = { 'Accept': 'application/json' };
                    if (csrfToken && csrfHeader) { headers[csrfHeader] = csrfToken; }

                    // Aquí iría tu llamada fetch DELETE...
                    // Por ahora cerramos el modal
                    cerrarConfirmacionEliminarCRF();
                    alert("Lógica de eliminación pendiente de implementación completa.");
                }

                async function verDatosFaltantes(crfId) {
                    if (!modalDatosFaltantes) return;

                    const titulo = document.getElementById('modal-faltantes-titulo');
                    const body = document.getElementById('modal-faltantes-body');

                    titulo.innerText = 'Datos Faltantes para CRF: ' + crfId;
                    body.innerHTML = '<p>Cargando...</p>';
                    modalDatosFaltantes.style.display = 'block';

                    try {
                        const response = await fetch(`/crf/api/crf/${crfId}/missing-data`);
                        if (!response.ok) throw new Error('No se pudo cargar la información.');

                        const missingFields = await response.json();

                        if (missingFields.length === 0) {
                            body.innerHTML = '<p style="color: var(--color-exito); font-weight: 600;">Este CRF está completo. No faltan datos.</p>';
                        } else {
                            let html = '<p>Los siguientes campos no tienen un valor registrado:</p><ul style="margin-left: 1.5rem; margin-top: 1rem;">';
                            for (const field of missingFields) {
                                html += `<li style="margin-bottom: 0.5rem;">${field}</li>`;
                            }
                            html += '</ul>';
                            body.innerHTML = html;
                        }
                    } catch (error) {
                        body.innerHTML = `<p style="color: var(--color-error);">${error.message}</p>`;
                    }
                }

                function cerrarModalDatosFaltantes() {
                    if (modalDatosFaltantes) modalDatosFaltantes.style.display = 'none';
                }

                async function verDetalleCrf(idCrf) {
                    if (!modalVerDetalle) return;

                    modalVerDetalle.style.display = 'block';
                    const tbody = document.getElementById('detalle-tabla-cuerpo');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 1rem;">Cargando datos...</td></tr>';

                    try {
                        const response = await fetch(`/crf/api/detalle/${idCrf}`);
                        if (!response.ok) throw new Error("No se pudo cargar el detalle");

                        const data = await response.json();

                        // Llenar datos fijos
                        const elId = document.getElementById('detalle-id-titulo');
                        if (elId) elId.textContent = data.idCrf; // (Aunque esté oculto)

                        document.getElementById('detalle-codigo').textContent = data.codigoPaciente || '-';
                        document.getElementById('detalle-nombre').textContent = data.nombrePaciente || '-';
                        document.getElementById('detalle-fecha').textContent = data.fechaConsulta || '-';
                        document.getElementById('detalle-tipo').textContent = data.esCasoEstudio ? 'Caso Estudio' : 'Caso Control';
                        document.getElementById('detalle-obs').textContent = data.observacion || 'Sin observaciones.';

                        // Llenar tabla dinámica
                        if (tbody) {
                            tbody.innerHTML = '';
                            if (data.campos && data.campos.length > 0) {
                                data.campos.forEach(campo => {
                                    const tr = document.createElement('tr');
                                    tr.style.borderBottom = '1px solid var(--color-fondo)';

                                    const tdNombre = document.createElement('td');
                                    tdNombre.textContent = campo.nombreCampo;
                                    tdNombre.style.padding = '0.5rem';
                                    tdNombre.style.fontWeight = '600';
                                    tdNombre.style.width = '60%';

                                    const tdValor = document.createElement('td');
                                    tdValor.textContent = campo.valor;
                                    tdValor.style.padding = '0.5rem';

                                    tr.appendChild(tdNombre);
                                    tr.appendChild(tdValor);
                                    tbody.appendChild(tr);
                                });
                            } else {
                                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:0.5rem;">No hay datos clínicos registrados.</td></tr>';
                            }
                        }
                    } catch (error) {
                        console.error(error);
                        const tbody = document.getElementById('detalle-tabla-cuerpo');
                        if (tbody) tbody.innerHTML = `<tr><td colspan="2" style="color:var(--color-error); text-align:center; padding: 1rem;">Error: ${error.message}</td></tr>`;
                    }
                }

                function cerrarModalDetalle() {
                    if (modalVerDetalle) modalVerDetalle.style.display = 'none';
                }

                window.onclick = function (event) {
                    if (event.target == modalConfirmacionCRF) cerrarConfirmacionEliminarCRF();
                    if (event.target == modalDatosFaltantes) cerrarModalDatosFaltantes();
                    if (event.target == modalVerDetalle) cerrarModalDetalle();
                }

                let isDown = false;
                let startX, startY, scrollLeft, scrollTop;

                if (slider) {
                    slider.addEventListener('mousedown', (e) => {
                        // Ignorar si se hace clic en un botón o enlace
                        if (e.target.closest('button') || e.target.closest('a')) return;

                        isDown = true;
                        slider.style.cursor = 'grabbing';
                        startX = e.pageX - slider.offsetLeft;
                        startY = e.pageY - slider.offsetTop;
                        scrollLeft = slider.scrollLeft;
                        scrollTop = slider.scrollTop;
                    });

                    slider.addEventListener('mouseleave', () => {
                        isDown = false;
                        slider.style.cursor = 'grab';
                    });

                    slider.addEventListener('mouseup', () => {
                        isDown = false;
                        slider.style.cursor = 'grab';
                    });

                    slider.addEventListener('mousemove', (e) => {
                        if (!isDown) return;
                        e.preventDefault();
                        const x = e.pageX - slider.offsetLeft;
                        const y = e.pageY - slider.offsetTop;
                        const walkX = (x - startX);
                        const walkY = (y - startY);
                        slider.scrollLeft = scrollLeft - walkX;
                        slider.scrollTop = scrollTop - walkY;
                    });
                }
            </script>
        </th:block>

    </div>
</body>

</html>
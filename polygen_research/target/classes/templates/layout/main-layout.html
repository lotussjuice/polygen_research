<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <script>
        (function () {
            try {
                // 1. Cargar Modo Oscuro
                var theme = localStorage.getItem('theme');
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                }

                // 2. Cargar Tema de Color 
                var appTheme = localStorage.getItem('appTheme');
                if (appTheme && appTheme !== 'default') {
                    document.documentElement.setAttribute('data-theme', appTheme);
                }
            } catch (e) { console.error("Error cargando preferencias", e); }
        })();
    </script>

    <title>DataClinic - Polygen Research</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>

<body class="">

    <div id="toast-container"></div>
    <audio id="notification-sound" th:src="@{/sounds/notification.mp3}" preload="auto"></audio>

    <div id="app-wrapper">

        <aside id="sidebar" th:fragment="sidebar">
            <div class="sidebar-header">
                <i class="ph-bold ph-first-aid-kit"></i>
                <h1 class="link-text">Polygen Research</h1>
            </div>

            <nav>
                <ul>
                    <li><a th:href="@{/inicio}" class="nav-link"><i class="ph-bold ph-house"></i><span
                                class="link-text">Inicio</span></a></li>

                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/crf/nuevo}" class="nav-link"><i class="ph-bold ph-clipboard-text"></i><span
                                class="link-text">Ingresar CRF</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/pacientes/list}" class="nav-link"><i class="ph-bold ph-users"></i><span
                                class="link-text">Gestionar Pacientes</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/campos/list}" class="nav-link"><i class="ph-bold ph-pencil-simple"></i><span
                                class="link-text">Gestor de Campos</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/crf/list}" class="nav-link"><i class="ph-bold ph-table"></i><span
                                class="link-text">Gestionar CRF</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/datos-crf/list}" class="nav-link"><i class="ph-bold ph-chart-line"></i><span
                                class="link-text">Ver Datos (Valores)</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/registros/list}" class="nav-link"><i class="ph-bold ph-archive"></i><span
                                class="link-text">Historial de modificacion</span></a>
                    </li>

                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR')">
                        <a th:href="@{/whitelist/list}" class="nav-link"><i class="ph-bold ph-shield-check"></i><span
                                class="link-text">Adm. Usuarios</span></a>
                    </li>

                    <li><a th:href="@{/faq}" class="nav-link"><i class="ph-bold ph-question"></i><span
                                class="link-text">Preguntas Frecuentes</span></a></li>
                </ul>
            </nav>

            <button id="sidebar-toggle" onclick="toggleMenu()" title="Colapsar/Expandir Menú">
                <i class="ph-bold ph-caret-double-left"></i>
            </button>

            <div class="sidebar-footer">
                <a href="https://mail.google.com/mail/?view=cm&fs=1&to=polygenresearchsys@gmail.com&su=Soporte%20Polygen%20Research" 
                target="_blank" 
                class="btn-soporte-theme"
                title="Contactar a Soporte">
                
                    <i class="ph-fill ph-envelope-simple"></i>
                    
                    <span class="link-text">Contacto / Soporte</span>
                </a>
            </div>
        </aside>

        <main id="main-content">

            <header id="app-header" th:fragment="header">
                <div class="header-left">
                    <span id="save-status"><i class="ph-fill ph-check-circle"></i> Autoguardado...</span>
                </div>

                <div class="header-right">

                    <label class="switch" title="Cambiar Modo" style="margin-right: 0.5rem;">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>

                    <div class="theme-wrapper" style="position: relative;">
                        <button class="icon-btn" onclick="toggleThemeMenu(event)" title="Cambiar Tema de Color">
                            <i class="ph-bold ph-palette"></i>
                        </button>

                        <div id="theme-dropdown" class="theme-dropdown" onclick="event.stopPropagation()">
                            <div
                                style="margin-bottom: 10px; border-bottom: 1px solid var(--color-borde); padding-bottom: 5px;">
                                <strong style="font-size: 0.9rem; color: var(--color-primario);">Apariencia</strong>
                            </div>

                            <p style="font-size: 0.8rem; color: var(--color-texto-secundario); margin-bottom: 0.5rem;">
                                Selecciona un tema:</p>

                            <div class="theme-grid">
                                <div class="theme-option" onclick="selectTheme('default')" id="theme-opt-default">
                                    <div class="theme-circle bg-default"></div>
                                    <span class="theme-label">Original</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('cream')" id="theme-opt-cream">
                                    <div class="theme-circle bg-cream"></div>
                                    <span class="theme-label">Cream</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('forest')" id="theme-opt-forest">
                                    <div class="theme-circle bg-forest"></div>
                                    <span class="theme-label">Forest</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('berry')" id="theme-opt-berry">
                                    <div class="theme-circle bg-berry"></div>
                                    <span class="theme-label">Berry</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('titanium')" id="theme-opt-titanium">
                                    <div class="theme-circle bg-titanium"></div>
                                    <span class="theme-label">Titan</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('sunset')" id="theme-opt-sunset">
                                    <div class="theme-circle bg-sunset"></div>
                                    <span class="theme-label">Sunset</span>
                                </div>

                                <div class="theme-option" onclick="selectTheme('aqua')" id="theme-opt-aqua">
                                    <div class="theme-circle bg-aqua"></div>
                                    <span class="theme-label">Aqua</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('royal')" id="theme-opt-royal">
                                    <div class="theme-circle bg-royal"></div>
                                    <span class="theme-label">Royal</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('cherry')" id="theme-opt-cherry">
                                    <div class="theme-circle bg-cherry"></div>
                                    <span class="theme-label">Cherry</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="notification-wrapper" style="position: relative;">
                        <button class="icon-btn" onclick="toggleNotifications()" title="Notificaciones">
                            <i class="ph-bold ph-bell"></i>
                            <span id="notif-dot" class="notification-dot"></span>
                        </button>
                        <div id="mini-popup" class="mini-notification-popup">
                            <strong id="mini-popup-user">Usuario</strong><br>
                            <span id="mini-popup-action">Acción...</span>
                        </div>
                        <div id="notif-dropdown" class="notification-dropdown">
                            <div
                                style="padding: 10px; border-bottom: 1px solid var(--color-borde); font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                                <span>Actividad Reciente</span>
                                <button onclick="marcarTodoLeido()"
                                    style="background:none; border:none; color: var(--color-primario); font-size: 0.7rem; cursor: pointer;">Marcar
                                    leído</button>
                            </div>
                            <div id="notif-list"></div>
                            <div style="padding: 10px; text-align: center; border-top: 1px solid var(--color-borde);">
                                <a th:href="@{/registros/list}" style="font-size: 0.8rem;">Ver historial</a>
                            </div>
                        </div>
                    </div>

                    <div class="profile-menu-container" style="position: relative;">
                        <button class="profile-trigger" onclick="toggleProfileMenu(event)" style="display: flex; align-items: center; gap: 8px; background: none; border: none; cursor: pointer;">
                            <span th:text="${#authentication.principal.nombreUsuario}" 
                                class="user-name-text" 
                                style="font-weight: 600; font-size: 0.95rem; color: var(--color-texto);">Usuario</span>
                            <i class="ph-bold ph-caret-down caret-icon" style="color: var(--color-texto);"></i>
                        </button>

                        <div id="profile-dropdown" class="profile-dropdown">
                            <div class="dropdown-header-info">
                                <strong th:text="${#authentication.principal.nombreUsuario}">Nombre</strong>
                                <small style="color: var(--color-texto-secundario);">Conectado</small>
                            </div>
                            
                            <ul class="dropdown-options">
                                <li>
                                    <a th:href="@{/perfil}">
                                        <i class="ph-bold ph-gear"></i> Mi Cuenta
                                    </a>
                                </li>
                                <li>
                                    <a href="#" onclick="document.getElementById('logoutForm').submit(); return false;" class="logout-link">
                                        <i class="ph-bold ph-sign-out"></i> Cerrar Sesión
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <form th:action="@{/logout}" method="post" id="logoutForm" style="display: none;">
                            <div th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            </div>
                        </form>
                    </div>
                    </div>
            </header>

            <div id="page-container">
                <div th:replace="~{this :: contenido}">
                    <p>El contenido de la página va aquí...</p>
                </div>
            </div>

        </main>
    </div>

    <div id="modalVerDetalleGlobal" class="modal" style="display: none;">
        <div class="modal-content"
            style="max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">

            <div class="modal-header" style="flex-shrink: 0;">
                <h2><i class="ph-bold ph-file-text"></i> Detalle CRF</h2>
                <span id="global-detalle-id-titulo" style="display: none;"></span>
                <span class="close-modal" onclick="cerrarModalDetalleGlobal()">&times;</span>
            </div>

            <div class="modal-body" style="overflow-y: auto; padding: 1.5rem;">
                <div class="detail-section"
                    style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                    <h4
                        style="color: var(--color-primario); margin-bottom: 0.5rem; font-size: 1.1rem; border-bottom: 2px solid var(--color-fondo); padding-bottom: 5px;">
                        <i class="ph-bold ph-user" style="margin-right: 5px;"></i> Paciente
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <p><strong>Código:</strong> <span id="global-detalle-codigo"></span></p>
                        <p><strong>Tipo Estudio:</strong> <span id="global-detalle-tipo"></span></p>
                        <p><strong>Nombre:</strong> <span id="global-detalle-nombre"></span></p>
                        <p><strong>Fecha Consulta:</strong> <span id="global-detalle-fecha"></span></p>
                    </div>
                </div>

                <div class="detail-section"
                    style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                    <h4
                        style="color: var(--color-primario); margin-bottom: 0.5rem; font-size: 1.1rem; border-bottom: 2px solid var(--color-fondo); padding-bottom: 5px;">
                        <i class="ph-bold ph-note" style="margin-right: 5px;"></i> Observaciones
                    </h4>
                    <p id="global-detalle-obs"
                        style="white-space: pre-wrap; font-style: italic; color: var(--color-texto-secundario); background: var(--color-fondo); padding: 10px; border-radius: 5px;">
                    </p>
                </div>

                <div id="global-detalle-contenido-dinamico">
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/js/main.js}"></script>

    <script>
        const modalGlobal = document.getElementById('modalVerDetalleGlobal');

        // Configuración de secciones (misma que en crf-list)
        const sectionConfigGlobal = {
            2: { title: "Datos sociodemográficos", icon: "ph-users" },
            3: { title: "Antecedentes clínicos", icon: "ph-heartbeat" },
            4: { title: "Variables antropométricas", icon: "ph-ruler" },
            5: { title: "Tabaquismo", icon: "ph-fire" },
            6: { title: "Consumo de alcohol", icon: "ph-brandy" },
            7: { title: "Factores dietarios y ambientales", icon: "ph-carrot" },
            8: { title: "Infección por Helicobacter pylori", icon: "ph-virus" },
            9: { title: "Histopatología (SOLO CASOS)", icon: "ph-microscope" }
        };

        async function verDetalleCrfGlobal(idCrf) {
            if (!modalGlobal) return;

            modalGlobal.style.display = 'block';
            const container = document.getElementById('global-detalle-contenido-dinamico');
            container.innerHTML = '<p style="text-align:center; padding: 1rem;">Cargando datos...</p>';

            try {
                const response = await fetch(`/crf/api/detalle/${idCrf}`);
                if (!response.ok) throw new Error("No se pudo cargar el detalle");
                const data = await response.json();

                // llenar datos fijos
                const elId = document.getElementById('global-detalle-id-titulo');
                if (elId) elId.textContent = data.idCrf;

                document.getElementById('global-detalle-codigo').textContent = data.codigoPaciente || '-';
                document.getElementById('global-detalle-nombre').textContent = data.nombrePaciente || '-';
                document.getElementById('global-detalle-fecha').textContent = data.fechaConsulta || '-';
                document.getElementById('global-detalle-tipo').textContent = data.esCasoEstudio ? 'Caso Estudio' : 'Caso Control';
                document.getElementById('global-detalle-obs').textContent = data.observacion || 'Sin observaciones.';

                // Agrupar por sección
                const groupedData = {};
                if (data.campos && data.campos.length > 0) {
                    data.campos.forEach(campo => {
                        const sec = campo.seccion || 99;
                        if (!groupedData[sec]) groupedData[sec] = [];
                        groupedData[sec].push(campo);
                    });
                }

                // Renderizar dinámicamente por secciones
                container.innerHTML = '';
                const sortedSections = Object.keys(groupedData).sort((a, b) => a - b);

                if (sortedSections.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">No hay datos clínicos registrados.</p>';
                } else {
                    sortedSections.forEach(secKey => {
                        const config = sectionConfigGlobal[secKey] || { title: `Sección ${secKey}`, icon: 'ph-list' };
                        const campos = groupedData[secKey];

                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'detail-section';
                        sectionDiv.style.marginBottom = '1.5rem';

                        const header = document.createElement('h4');
                        header.style.color = 'var(--color-primario)';
                        header.style.marginBottom = '0.5rem';
                        header.style.fontSize = '1.1rem';
                        header.style.borderBottom = '2px solid var(--color-fondo)';
                        header.style.paddingBottom = '5px';
                        header.innerHTML = `<i class="ph-bold ${config.icon}" style="margin-right: 5px;"></i> ${config.title}`;
                        sectionDiv.appendChild(header);

                        const table = document.createElement('table');
                        table.style.width = '100%';
                        table.style.borderCollapse = 'collapse';

                        const tbody = document.createElement('tbody');

                        campos.forEach(campo => {
                            const tr = document.createElement('tr');
                            tr.style.borderBottom = '1px solid var(--color-fondo)';

                            const tdNombre = document.createElement('td');
                            tdNombre.textContent = campo.nombreCampo;
                            tdNombre.style.padding = '0.5rem';
                            tdNombre.style.fontWeight = '600';
                            tdNombre.style.width = '60%';
                            tdNombre.style.color = '#444'; // Color texto oscuro

                            const tdValor = document.createElement('td');
                            tdValor.textContent = campo.valor;
                            tdValor.style.padding = '0.5rem';

                            tr.appendChild(tdNombre);
                            tr.appendChild(tdValor);
                            tbody.appendChild(tr);
                        });

                        table.appendChild(tbody);
                        sectionDiv.appendChild(table);
                        container.appendChild(sectionDiv);
                    });
                }

            } catch (error) {
                console.error(error);
                container.innerHTML = `<p style="color:var(--color-error); text-align:center;">Error: ${error.message}</p>`;
            }
        }

        function cerrarModalDetalleGlobal() {
            if (modalGlobal) modalGlobal.style.display = 'none';
        }

        // --- SONIDO ---
        function reproducirSonido() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => { });
            }
        }

        // --- TOASTS ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? '<i class="ph-bold ph-check-circle" style="color:var(--color-exito)"></i>' :
                type === 'error' ? '<i class="ph-bold ph-warning-circle" style="color:var(--color-error)"></i>' :
                    '<i class="ph-bold ph-info"></i>';
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);

            if (type !== 'info') reproducirSonido();

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        }

        // --- NOTIFICACIONES ---
        const STORAGE_KEY_LAST_SEEN = 'polygen_last_notification_date';
        const STORAGE_KEY_LAST_ALERTED_ID = 'polygen_last_alerted_id';
        let ultimosRegistrosCache = [];
        let areNotificationsLoaded = false;

        document.addEventListener('DOMContentLoaded', () => {
            const successMsg = "[[${successMessage}]]";
            const errorMsg = "[[${errorMessage}]]";
            if (successMsg && successMsg !== 'null' && successMsg.trim() !== '') {
                showToast(successMsg, 'success');
                document.getElementById('notif-dot').classList.add('active');
            }
            if (errorMsg && errorMsg !== 'null' && errorMsg.trim() !== '') showToast(errorMsg, 'error');

            checkNewNotifications();
            setInterval(checkNewNotifications, 10000);
        });

        async function checkNewNotifications() {
            try {
                const response = await fetch('/registros/api/recent');
                if (!response.ok) return;

                const data = await response.json();
                ultimosRegistrosCache = data;

                if (data.length > 0) {
                    const ultimaActividad = data[0];
                    const fechaServidor = new Date(ultimaActividad.fechaActividad).getTime();
                    const ultimaVisto = localStorage.getItem(STORAGE_KEY_LAST_SEEN) || 0;
                    const ultimoIdAlertado = parseInt(localStorage.getItem(STORAGE_KEY_LAST_ALERTED_ID) || '0');

                    if (fechaServidor > ultimaVisto) {
                        document.getElementById('notif-dot').classList.add('active');
                    }

                    // Sonido solo si es ID nuevo
                    if (fechaServidor > ultimaVisto && ultimaActividad.idRegistro > ultimoIdAlertado) {
                        activarNotificacionVisual(ultimaActividad);
                        localStorage.setItem(STORAGE_KEY_LAST_ALERTED_ID, ultimaActividad.idRegistro);
                    }
                }
            } catch (e) { console.error(e); }
        }

        function activarNotificacionVisual(actividad) {
            const popup = document.getElementById('mini-popup');
            reproducirSonido();
            if (popup) {
                document.getElementById('mini-popup-user').textContent = actividad.usuarioNombre;
                document.getElementById('mini-popup-action').textContent = actividad.tipoActividad;
                popup.classList.add('show');
                setTimeout(() => popup.classList.remove('show'), 5000);
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notif-dropdown');
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                dropdown.classList.add('show');
                document.getElementById('notif-dot').classList.remove('active');
                document.getElementById('mini-popup').classList.remove('show');

                if (ultimosRegistrosCache.length > 0) {
                    const fechaMasReciente = new Date(ultimosRegistrosCache[0].fechaActividad).getTime();
                    localStorage.setItem(STORAGE_KEY_LAST_SEEN, fechaMasReciente);
                }
                renderizarListaNotificaciones(ultimosRegistrosCache);
            }
        }

        function renderizarListaNotificaciones(data) {
            const list = document.getElementById('notif-list');
            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = '<div class="notification-item" style="text-align:center; padding: 10px;">Sin actividad reciente</div>';
                return;
            }
            data.forEach(reg => {
                const date = new Date(reg.fechaActividad).toLocaleString();
                // Botones usando la función global
                let buttonsHtml = '';
                if (reg.crfId) {
                    buttonsHtml = `
                        <div class="btn-group-xs" style="margin-left: auto;">
                            <button onclick="abrirModalDetalleGlobal(${reg.crfId}, event)" class="btn-secundario btn-xs" title="Ver">
                                <i class="ph-bold ph-eye"></i>
                            </button>
                            <a href="/crf/editar/${reg.crfId}" class="btn-secundario btn-xs" title="Editar">
                                <i class="ph-bold ph-pencil-simple"></i>
                            </a>
                        </div>`;
                }
                const item = `
                    <div class="notification-item" style="display:flex; align-items:center; gap: 10px;">
                        <div style="flex-grow: 1;">
                            <div style="font-weight:600; font-size: 0.85rem;">${reg.usuarioNombre}</div>
                            <div style="font-size:0.8rem; color: var(--color-texto-secundario);">${reg.tipoActividad}</div>
                            <span class="notification-time" style="font-size: 0.7rem;">${date}</span>
                        </div>
                        ${buttonsHtml}
                    </div>`;
                list.innerHTML += item;
            });
        }

        function marcarTodoLeido() {
            if (ultimosRegistrosCache.length > 0) {
                const fechaMasReciente = new Date(ultimosRegistrosCache[0].fechaActividad).getTime();
                localStorage.setItem(STORAGE_KEY_LAST_SEEN, fechaMasReciente);
            }
            document.getElementById('notif-dot').classList.remove('active');
            document.getElementById('notif-dropdown').classList.remove('show');
        }

        function abrirModalDetalleGlobal(id, event) {
            if (event) event.stopPropagation();
            // Llamamos directamente a nuestra nueva función global
            verDetalleCrfGlobal(id);
        }
        function toggleProfileMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        window.addEventListener('click', function (e) {
            const wrapper = document.querySelector('.notification-wrapper');
            const dropdown = document.getElementById('notif-dropdown');
            if (wrapper && dropdown && !wrapper.contains(e.target)) {
                dropdown.classList.remove('show');
            }
            
            const profileWrapper = document.querySelector('.profile-menu-container');
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileWrapper && profileDropdown && !profileWrapper.contains(e.target)) {
                profileDropdown.classList.remove('show');
            }

            // Cerrar modal global si clic fuera
            if (e.target == modalGlobal) cerrarModalDetalleGlobal();
        });
    </script>

    <th:block th:replace="${pageScript} ?: ~{}" />

</body>

</html>
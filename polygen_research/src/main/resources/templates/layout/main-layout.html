<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <script>
        (function () {
            try {
                // 1. Cargar Modo Oscuro
                var theme = localStorage.getItem('theme');
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                }

                // 2. Cargar Tema de Color 
                var appTheme = localStorage.getItem('appTheme');
                if (appTheme && appTheme !== 'default') {
                    document.documentElement.setAttribute('data-theme', appTheme);
                }
            } catch (e) { console.error("Error cargando preferencias", e); }
        })();
    </script>

    <title>DataClinic - Polygen Research</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>

<body class="">

    <div id="toast-container"></div>
    <audio id="notification-sound" th:src="@{/sounds/notification.mp3}" preload="auto"></audio>

    <div id="app-wrapper">

        <aside id="sidebar" th:fragment="sidebar">
            <div class="sidebar-header">
                <i class="ph-bold ph-first-aid-kit"></i>
                <h1 class="link-text">Polygen Research</h1>
            </div>

            <nav>
                <ul>
                    <li><a th:href="@{/inicio}" class="nav-link"><i class="ph-bold ph-house"></i><span
                                class="link-text">Inicio</span></a></li>

                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/crf/nuevo}" class="nav-link"><i class="ph-bold ph-clipboard-text"></i><span
                                class="link-text">Ingresar CRF</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/pacientes/list}" class="nav-link"><i class="ph-bold ph-users"></i><span
                                class="link-text">Gestionar Pacientes</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/campos/list}" class="nav-link"><i class="ph-bold ph-pencil-simple"></i><span
                                class="link-text">Gestor de Campos</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/crf/list}" class="nav-link"><i class="ph-bold ph-table"></i><span
                                class="link-text">Gestionar CRF</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/datos-crf/list}" class="nav-link"><i class="ph-bold ph-chart-line"></i><span
                                class="link-text">Ver Datos (Valores)</span></a>
                    </li>
                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR', 'INVESTIGADOR')">
                        <a th:href="@{/registros/list}" class="nav-link"><i class="ph-bold ph-archive"></i><span
                                class="link-text">Historial de modificacion</span></a>
                    </li>

                    <li sec:authorize="hasAnyRole('DEV', 'ADMINISTRADOR')">
                        <a th:href="@{/whitelist/list}" class="nav-link"><i class="ph-bold ph-shield-check"></i><span
                                class="link-text">Adm. Usuarios</span></a>
                    </li>

                    <li><a th:href="@{/faq}" class="nav-link"><i class="ph-bold ph-question"></i><span
                                class="link-text">Preguntas Frecuentes</span></a></li>
                </ul>
            </nav>

            <button id="sidebar-toggle" onclick="toggleMenu()" title="Colapsar/Expandir Menú">
                <i class="ph-bold ph-caret-double-left"></i>
            </button>

            <div class="sidebar-footer">
                <p><i class="ph-fill ph-lock-simple"></i> <span class="link-text">Conexión Segura (Cifrado)</span></p>
            </div>
        </aside>

        <main id="main-content">

            <header id="app-header" th:fragment="header">
                <div class="header-left">
                    <span id="save-status"><i class="ph-fill ph-check-circle"></i> Autoguardado...</span>
                </div>

                <div class="header-right">

                    <label class="switch" title="Cambiar Modo" style="margin-right: 0.5rem;">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>

                    <div class="theme-wrapper" style="position: relative;">
                        <button class="icon-btn" onclick="toggleThemeMenu(event)" title="Cambiar Tema de Color">
                            <i class="ph-bold ph-palette"></i>
                        </button>

                        <div id="theme-dropdown" class="theme-dropdown" onclick="event.stopPropagation()">
                            <div
                                style="margin-bottom: 10px; border-bottom: 1px solid var(--color-borde); padding-bottom: 5px;">
                                <strong style="font-size: 0.9rem; color: var(--color-primario);">Apariencia</strong>
                            </div>

                            <p style="font-size: 0.8rem; color: var(--color-texto-secundario); margin-bottom: 0.5rem;">
                                Selecciona un tema:</p>

                            <div class="theme-grid">
                                <div class="theme-option" onclick="selectTheme('default')" id="theme-opt-default">
                                    <div class="theme-circle bg-default"></div>
                                    <span class="theme-label">Original</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('cream')" id="theme-opt-cream">
                                    <div class="theme-circle bg-cream"></div>
                                    <span class="theme-label">Cream</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('forest')" id="theme-opt-forest">
                                    <div class="theme-circle bg-forest"></div>
                                    <span class="theme-label">Forest</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('berry')" id="theme-opt-berry">
                                    <div class="theme-circle bg-berry"></div>
                                    <span class="theme-label">Berry</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('titanium')" id="theme-opt-titanium">
                                    <div class="theme-circle bg-titanium"></div>
                                    <span class="theme-label">Titan</span>
                                </div>
                                <div class="theme-option" onclick="selectTheme('sunset')" id="theme-opt-sunset">
                                    <div class="theme-circle bg-sunset"></div>
                                    <span class="theme-label">Sunset</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="notification-wrapper" style="position: relative;">
                        <button class="icon-btn" onclick="toggleNotifications()" title="Notificaciones">
                            <i class="ph-bold ph-bell"></i>
                            <span id="notif-dot" class="notification-dot"></span>
                        </button>
                        <div id="mini-popup" class="mini-notification-popup">
                            <strong id="mini-popup-user">Usuario</strong><br>
                            <span id="mini-popup-action">Acción...</span>
                        </div>
                        <div id="notif-dropdown" class="notification-dropdown">
                            <div
                                style="padding: 10px; border-bottom: 1px solid var(--color-borde); font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                                <span>Actividad Reciente</span>
                                <button onclick="marcarTodoLeido()"
                                    style="background:none; border:none; color: var(--color-primario); font-size: 0.7rem; cursor: pointer;">Marcar
                                    leído</button>
                            </div>
                            <div id="notif-list"></div>
                            <div style="padding: 10px; text-align: center; border-top: 1px solid var(--color-borde);">
                                <a th:href="@{/registros/list}" style="font-size: 0.8rem;">Ver historial</a>
                            </div>
                        </div>
                    </div>

                    <div class="profile-menu" style="display: flex; align-items: center; gap: 8px;">
                        <span th:text="${#authentication.principal.nombreUsuario}"
                            style="font-weight: 600;">Usuario</span>

                        <button onclick="document.getElementById('logoutForm').submit();" class="icon-btn"
                            title="Cerrar Sesión"
                            style="margin-left: 0.5rem; background: none; border: none; cursor: pointer;">
                            <i class="ph-bold ph-sign-out" style="font-size: 1.2rem; color: var(--color-texto);"></i>
                        </button>
                        <form th:action="@{/logout}" method="post" id="logoutForm" style="display: none;">
                            <div th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            </div>
                        </form>
                    </div>
                </div>
            </header>

            <div id="page-container">
                <div th:replace="~{this :: contenido}">
                    <p>El contenido de la página va aquí...</p>
                </div>
            </div>

        </main>
    </div>

    <div id="modalVerDetalleGlobal" class="modal" style="display: none;">
        <div class="modal-content"
            style="max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">

            <div class="modal-header" style="flex-shrink: 0;">
                <h2><i class="ph-bold ph-file-text"></i> Detalle CRF</h2>
                <span id="global-detalle-id-titulo" style="display: none;"></span>
                <span class="close-modal" onclick="cerrarModalDetalleGlobal()">&times;</span>
            </div>

            <div class="modal-body" style="overflow-y: auto; padding: 1.5rem;">
                <div class="detail-section"
                    style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                    <h4 style="color: var(--color-primario); margin-bottom: 0.5rem;">Paciente</h4>
                    <p><strong>Código:</strong> <span id="global-detalle-codigo"></span></p>
                    <p><strong>Nombre:</strong> <span id="global-detalle-nombre"></span></p>
                    <p><strong>Fecha Consulta:</strong> <span id="global-detalle-fecha"></span></p>
                    <p><strong>Tipo Estudio:</strong> <span id="global-detalle-tipo"></span></p>
                </div>

                <div class="detail-section"
                    style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                    <h4 style="color: var(--color-primario); margin-bottom: 0.5rem;">Observaciones</h4>
                    <p id="global-detalle-obs"
                        style="white-space: pre-wrap; font-style: italic; color: var(--color-texto-secundario);"></p>
                </div>

                <div class="detail-section">
                    <h4 style="color: var(--color-primario); margin-bottom: 1rem;">Datos Clínicos</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tbody id="global-detalle-tabla-cuerpo"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/js/main.js}"></script>

    <script>
        const modalGlobal = document.getElementById('modalVerDetalleGlobal');

        async function verDetalleCrfGlobal(idCrf) {
            if (!modalGlobal) return;

            modalGlobal.style.display = 'block';
            const tbody = document.getElementById('global-detalle-tabla-cuerpo');
            if (tbody) tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 1rem;">Cargando datos...</td></tr>';

            try {
                const response = await fetch(`/crf/api/detalle/${idCrf}`);
                if (!response.ok) throw new Error("No se pudo cargar el detalle");
                const data = await response.json();

                // llenar datos
                const elId = document.getElementById('global-detalle-id-titulo');
                if (elId) elId.textContent = data.idCrf;

                document.getElementById('global-detalle-codigo').textContent = data.codigoPaciente || '-';
                document.getElementById('global-detalle-nombre').textContent = data.nombrePaciente || '-';
                document.getElementById('global-detalle-fecha').textContent = data.fechaConsulta || '-';
                document.getElementById('global-detalle-tipo').textContent = data.esCasoEstudio ? 'Caso Estudio' : 'Caso Control';
                document.getElementById('global-detalle-obs').textContent = data.observacion || 'Sin observaciones.';

                if (tbody) {
                    tbody.innerHTML = '';
                    if (data.campos && data.campos.length > 0) {
                        data.campos.forEach(campo => {
                            const tr = document.createElement('tr');
                            tr.style.borderBottom = '1px solid var(--color-fondo)';
                            const tdNombre = document.createElement('td');
                            tdNombre.textContent = campo.nombreCampo;
                            tdNombre.style.padding = '0.5rem';
                            tdNombre.style.fontWeight = '600';
                            tdNombre.style.width = '60%';
                            const tdValor = document.createElement('td');
                            tdValor.textContent = campo.valor;
                            tdValor.style.padding = '0.5rem';
                            tr.appendChild(tdNombre);
                            tr.appendChild(tdValor);
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:0.5rem;">No hay datos clínicos.</td></tr>';
                    }
                }
            } catch (error) {
                console.error(error);
                if (tbody) tbody.innerHTML = `<tr><td colspan="2" style="color:var(--color-error); text-align:center;">Error: ${error.message}</td></tr>`;
            }
        }

        function cerrarModalDetalleGlobal() {
            if (modalGlobal) modalGlobal.style.display = 'none';
        }

        // --- SONIDO ---
        function reproducirSonido() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => { });
            }
        }

        // --- TOASTS ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? '<i class="ph-bold ph-check-circle" style="color:var(--color-exito)"></i>' :
                type === 'error' ? '<i class="ph-bold ph-warning-circle" style="color:var(--color-error)"></i>' :
                    '<i class="ph-bold ph-info"></i>';
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);

            if (type !== 'info') reproducirSonido();

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        }

        // --- NOTIFICACIONES ---
        const STORAGE_KEY_LAST_SEEN = 'polygen_last_notification_date';
        const STORAGE_KEY_LAST_ALERTED_ID = 'polygen_last_alerted_id';
        let ultimosRegistrosCache = [];
        let areNotificationsLoaded = false;

        document.addEventListener('DOMContentLoaded', () => {
            const successMsg = "[[${successMessage}]]";
            const errorMsg = "[[${errorMessage}]]";
            if (successMsg && successMsg !== 'null' && successMsg.trim() !== '') {
                showToast(successMsg, 'success');
                document.getElementById('notif-dot').classList.add('active');
            }
            if (errorMsg && errorMsg !== 'null' && errorMsg.trim() !== '') showToast(errorMsg, 'error');

            checkNewNotifications();
            setInterval(checkNewNotifications, 10000);
        });

        async function checkNewNotifications() {
            try {
                const response = await fetch('/registros/api/recent');
                if (!response.ok) return;

                const data = await response.json();
                ultimosRegistrosCache = data;

                if (data.length > 0) {
                    const ultimaActividad = data[0];
                    const fechaServidor = new Date(ultimaActividad.fechaActividad).getTime();
                    const ultimaVisto = localStorage.getItem(STORAGE_KEY_LAST_SEEN) || 0;
                    const ultimoIdAlertado = parseInt(localStorage.getItem(STORAGE_KEY_LAST_ALERTED_ID) || '0');

                    if (fechaServidor > ultimaVisto) {
                        document.getElementById('notif-dot').classList.add('active');
                    }

                    // Sonido solo si es ID nuevo
                    if (fechaServidor > ultimaVisto && ultimaActividad.idRegistro > ultimoIdAlertado) {
                        activarNotificacionVisual(ultimaActividad);
                        localStorage.setItem(STORAGE_KEY_LAST_ALERTED_ID, ultimaActividad.idRegistro);
                    }
                }
            } catch (e) { console.error(e); }
        }

        function activarNotificacionVisual(actividad) {
            const popup = document.getElementById('mini-popup');
            reproducirSonido();
            if (popup) {
                document.getElementById('mini-popup-user').textContent = actividad.usuarioNombre;
                document.getElementById('mini-popup-action').textContent = actividad.tipoActividad;
                popup.classList.add('show');
                setTimeout(() => popup.classList.remove('show'), 5000);
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notif-dropdown');
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                dropdown.classList.add('show');
                document.getElementById('notif-dot').classList.remove('active');
                document.getElementById('mini-popup').classList.remove('show');

                if (ultimosRegistrosCache.length > 0) {
                    const fechaMasReciente = new Date(ultimosRegistrosCache[0].fechaActividad).getTime();
                    localStorage.setItem(STORAGE_KEY_LAST_SEEN, fechaMasReciente);
                }
                renderizarListaNotificaciones(ultimosRegistrosCache);
            }
        }

        function renderizarListaNotificaciones(data) {
            const list = document.getElementById('notif-list');
            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = '<div class="notification-item" style="text-align:center; padding: 10px;">Sin actividad reciente</div>';
                return;
            }
            data.forEach(reg => {
                const date = new Date(reg.fechaActividad).toLocaleString();
                // Botones usando la función global
                let buttonsHtml = '';
                if (reg.crfId) {
                    buttonsHtml = `
                        <div class="btn-group-xs" style="margin-left: auto;">
                            <button onclick="abrirModalDetalleGlobal(${reg.crfId}, event)" class="btn-secundario btn-xs" title="Ver">
                                <i class="ph-bold ph-eye"></i>
                            </button>
                            <a href="/crf/editar/${reg.crfId}" class="btn-secundario btn-xs" title="Editar">
                                <i class="ph-bold ph-pencil-simple"></i>
                            </a>
                        </div>`;
                }
                const item = `
                    <div class="notification-item" style="display:flex; align-items:center; gap: 10px;">
                        <div style="flex-grow: 1;">
                            <div style="font-weight:600; font-size: 0.85rem;">${reg.usuarioNombre}</div>
                            <div style="font-size:0.8rem; color: var(--color-texto-secundario);">${reg.tipoActividad}</div>
                            <span class="notification-time" style="font-size: 0.7rem;">${date}</span>
                        </div>
                        ${buttonsHtml}
                    </div>`;
                list.innerHTML += item;
            });
        }

        function marcarTodoLeido() {
            if (ultimosRegistrosCache.length > 0) {
                const fechaMasReciente = new Date(ultimosRegistrosCache[0].fechaActividad).getTime();
                localStorage.setItem(STORAGE_KEY_LAST_SEEN, fechaMasReciente);
            }
            document.getElementById('notif-dot').classList.remove('active');
            document.getElementById('notif-dropdown').classList.remove('show');
        }

        function abrirModalDetalleGlobal(id, event) {
            if (event) event.stopPropagation();
            // Llamamos directamente a nuestra nueva función global
            verDetalleCrfGlobal(id);
        }

        window.addEventListener('click', function (e) {
            const wrapper = document.querySelector('.notification-wrapper');
            const dropdown = document.getElementById('notif-dropdown');
            if (wrapper && dropdown && !wrapper.contains(e.target)) {
                dropdown.classList.remove('show');
            }
            // Cerrar modal global si clic fuera
            if (e.target == modalGlobal) cerrarModalDetalleGlobal();
        });
    </script>

    <th:block th:replace="${pageScript} ?: ~{}" />

</body>

</html>
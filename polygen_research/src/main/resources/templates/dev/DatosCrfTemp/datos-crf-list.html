<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main-layout :: ~{}}">

<body>
    <div th:fragment="contenido" style="position: relative; min-height: 80vh;">

        <div id="loading-overlay">
            <div class="loader-spinner"></div>
            <div class="loader-text">Procesando datos...</div>
        </div>

        <script src="https://unpkg.com/@phosphor-icons/web"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <style>
            /* --- ESTILOS GENERALES --- */
            .border-section-start { border-left: 2px solid var(--color-borde) !important; }
            .header-icon { font-size: 1.1rem; color: var(--color-primario); margin-right: 4px; vertical-align: middle; }
            
            /* --- DRAG & SCROLL --- */
            .table-responsive-wrapper {
                overflow-x: auto;
                white-space: nowrap;
                cursor: grab;
                max-width: 100%;
                user-select: none;
                padding-bottom: 5px;
                border: 1px solid var(--color-borde);
                border-radius: 8px;
                background-color: var(--color-tarjeta);
            }
            .table-responsive-wrapper.grabbing { cursor: grabbing; cursor: -webkit-grabbing; }

            .col-excluded { background-color: var(--color-fondo) !important; color: var(--color-texto-secundario) !important; text-decoration: line-through; opacity: 0.6; }
            
            th { vertical-align: middle !important; padding: 10px 12px !important; background-color: var(--color-fondo); color: var(--color-texto-secundario); font-weight: 600; border-bottom: 2px solid var(--color-borde); }
            .th-container { display: flex; justify-content: space-between; align-items: center; gap: 8px; min-width: 160px; }
            .th-text { color: var(--color-texto); }

            /* STICKY COLUMNS */
            .tabla-bonita tbody td:first-child { position: sticky; left: 0; z-index: 10; background-color: var(--color-tarjeta) !important; border-right: 2px solid var(--color-borde); box-shadow: 2px 0 5px rgba(0,0,0,0.05); color: var(--color-texto); font-weight: 600; }
            .tabla-bonita thead th:first-child { position: sticky; left: 0; z-index: 20; background-color: var(--color-fondo) !important; border-right: 2px solid var(--color-borde); box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
            .tabla-bonita tfoot td:first-child { position: sticky; left: 0; z-index: 20; background-color: var(--color-fondo) !important; border-right: 2px solid var(--color-borde); box-shadow: 2px 0 5px rgba(0,0,0,0.05); color: var(--color-texto-secundario); }
            .tabla-bonita tfoot td { background-color: var(--color-fondo); border-top: 2px solid var(--color-primario); font-weight: 600; color: var(--color-texto); }

            /* HEADER BUTTONS */
            .th-actions { display: flex; gap: 4px; flex-shrink: 0; }
            .btn-th-action { width: 26px; height: 26px; padding: 0; font-size: 0.85rem; line-height: 1; border: 1px solid var(--color-borde); background: var(--color-tarjeta); color: var(--color-texto-secundario); border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; cursor: pointer; }
            .btn-th-action:hover { background: var(--color-primario); color: white; border-color: var(--color-primario); }
            .btn-th-action.trash:hover { background: var(--color-error); border-color: var(--color-error); color: white; }

            /* LOGIC BUILDER */
            .logic-header-bar { background-color: var(--color-tarjeta); padding: 15px; border-radius: 8px; border: 1px solid var(--color-borde); margin-bottom: 20px; display: flex; align-items: flex-end; gap: 15px; box-shadow: var(--sombra-tarjeta); }
            .logic-container { display: flex; flex-direction: column; gap: 20px; padding-bottom: 10px; }
            .logic-card { background: var(--color-tarjeta); border: 1px solid var(--color-borde); border-left: 4px solid var(--color-primario); border-radius: 8px; box-shadow: var(--sombra-tarjeta); transition: transform 0.2s; }
            .logic-card-header { background-color: var(--color-fondo); padding: 10px 15px; border-bottom: 1px solid var(--color-borde); border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; color: var(--color-texto); }
            .logic-card-body { padding: 15px; color: var(--color-texto); }
            .logic-select { font-weight: 600; font-size: 0.85rem; padding: 4px 10px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; }
            .logic-select.and { background-color: #e3f2fd; color: #0d47a1; border-color: #bbdefb; }
            .logic-select.or { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
            .rule-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; padding: 8px 12px; background: var(--color-tarjeta); border: 1px solid var(--color-borde); border-radius: 6px; }
            .rule-row:hover { border-color: var(--color-primario); }
            .rule-field { flex: 2; font-weight: 500; color: var(--color-texto); }
            .rule-op { flex: 0 0 120px; }
            .rule-val { flex: 2; }
            
            /* MODALES */
            .modal-content { background-color: var(--color-tarjeta); color: var(--color-texto); border: 1px solid var(--color-borde); }
            .modal-header { background-color: var(--color-tarjeta); border-bottom: 1px solid var(--color-borde); }
            .modal-footer { border-top: 1px solid var(--color-borde); }
            .modal-title { font-weight: 700; color: var(--color-primario); font-size: 1.1rem; }
            .form-control, .form-select { background-color: var(--color-fondo); color: var(--color-texto); border: 1px solid var(--color-borde); }
            .form-control:focus, .form-select:focus { border-color: var(--color-primario); background-color: var(--color-tarjeta); color: var(--color-texto); }
            .btn-subtle { border: 1px dashed var(--color-borde); color: var(--color-texto-secundario); background: var(--color-fondo); transition: all 0.2s; }
            .btn-subtle:hover { border-color: var(--color-primario); color: var(--color-primario); background: var(--color-tarjeta); }

            /* --- PANTALLA DE CARGA --- */
            #loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: var(--color-fondo); 
                z-index: 50;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                transition: opacity 0.5s ease, visibility 0.5s ease;
                border-radius: 12px;
            }

            .loader-spinner {
                width: 50px;
                height: 50px;
                border: 5px solid var(--color-borde);
                border-top: 5px solid var(--color-primario);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 1rem;
            }

            .loader-text {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--color-texto);
                animation: pulse 1.5s infinite ease-in-out;
            }

            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

            .loader-hidden {
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
            }

            /* --- FIX COLAPSABLE AYUDA --- */
            #guiaUsoCollapse { display: none; overflow: hidden; }
            #guiaUsoCollapse.show { display: block; animation: slideDownFade 0.3s ease-out; }
            @keyframes slideDownFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

            /* --- MODO OSCURO PARA BOTONES EXPORTAR (NUEVO) --- */
            .dark-mode .btn-export {
                background-color: transparent; /* Quitar fondo blanco */
                box-shadow: none;
            }
            /* Excel Dark */
            .dark-mode .btn-export-excel {
                color: #4ade80; /* Verde brillante legible en oscuro */
                border-color: #4ade80;
            }
            .dark-mode .btn-export-excel:hover {
                background-color: rgba(74, 222, 128, 0.1); /* Tinte verde suave */
            }
            /* Stata Dark */
            .dark-mode .btn-export-stata {
                color: #60a5fa; /* Azul brillante legible en oscuro */
                border-color: #60a5fa;
            }
            .dark-mode .btn-export-stata:hover {
                background-color: rgba(96, 165, 250, 0.1); /* Tinte azul suave */
            }
        </style>

        <script th:inline="javascript">
            /*<![CDATA[*/
            const fieldsMetadata = {};
            /*[# th:each="col : ${camposColumnas}"]*/
                /*[# th:if="${col.campoCrf.tipo != 'TEXTO' and col.campoCrf.tipo != 'FECHA'}"]*/  fieldsMetadata["" + /*[[${col.campoCrf.idCampo}]]*/ "0"] = {
                    id: "" + /*[[${col.campoCrf.idCampo}]]*/ "0",
                    nombre: /*[[${col.campoCrf.nombre}]]*/ "",
                    tipo: /*[[${col.campoCrf.tipo}]]*/ "",
                    opciones: []
                };
                /*[# th:if="${col.campoCrf.opciones != null}"]*/
                    /*[# th:each="op : ${col.campoCrf.opciones}"]*/
                    fieldsMetadata["" + /*[[${col.campoCrf.idCampo}]]*/ "0"].opciones.push({
                        val: "" + /*[[${op.orden}]]*/ "0",
                        text: /*[[${op.etiqueta}]]*/ ""
                    });
                    /*[/]*/
                /*[/]*/
                /*[/]*/ /*[/]*/
        </script>

        <div class="card">
            <div class="card-header">
                <h3><i class="ph-bold ph-chart-line"></i> Matriz de datos numéricos</h3>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <form th:action="@{/datos-crf/list}" method="get" style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" name="codigoPaciente" class="form-control" placeholder="Cód. paciente..." th:value="${param.codigoPaciente}" />
                        <button type="submit" class="btn-primario btn-sm">Buscar</button> 
                        <a th:href="@{/datos-crf/list}" class="btn-secundario btn-sm">Limpiar</a>
                    </form>

                    <div style="display: flex; align-items: center; background: var(--color-fondo); padding: 0.4rem 0.8rem; border-radius: 8px; border: 1px solid var(--color-borde);">
                        <label class="switch" style="margin-right: 0.5rem; margin-bottom: 0;">
                            <input type="checkbox" id="checkPersistencia">
                            <span class="slider slider-clean"></span>
                        </label>
                        <span style="font-size: 0.9rem; color: var(--color-texto);">Guardar Config</span>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                
                <div class="mb-5">
                    <button class="btn-subtle btn-sm" type="button" 
                            onclick="var el = document.getElementById('guiaUsoCollapse'); el.classList.toggle('show');"
                            style="width: 100%; text-align: left; padding: 0.8rem; display: flex; align-items: center; justify-content: space-between;">
                        <span><i class="ph-bold ph-info" style="margin-right: 8px;"></i> Guía de uso y ayuda</span>
                        <i class="ph-bold ph-caret-down"></i>
                    </button>
                    
                    <div class="collapse" id="guiaUsoCollapse">
                        <div class="alert alert-light border shadow-sm mt-2" style="background-color: var(--color-fondo); border-color: var(--color-borde) !important; color: var(--color-texto); border-top: none; border-radius: 0 0 8px 8px;">
                            <ul class="mb-0 ps-3" style="font-size: 0.95rem; color: var(--color-texto-secundario);">
                                <li class="mb-2"><strong>Guardar Config:</strong> Si activa esta opción, el navegador recordará sus variables calculadas y columnas ocultas para la próxima vez que ingrese.</li>
                                <li class="mb-2"><strong>Crear Variable (+):</strong> Permite crear una nueva columna basada en cálculos o lógica compleja.</li>
                                <li class="mb-2"><strong>Ocultar Columna (Ojo):</strong> Excluye temporalmente una columna de la visualización y de la exportación final.</li>
                                <li><strong>Exportación:</strong> Los archivos generados respetarán su configuración actual de columnas visibles y variables creadas.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mb-4">
                    <button type="button" id="btn-excel-confirm" class="btn-export btn-export-excel">
                        <i class="ph-bold ph-file-xls"></i> Exportar a Excel
                    </button>
                    <button type="button" id="btn-stata-preview" class="btn-export btn-export-stata">
                        <i class="ph-bold ph-file"></i> Exportar para STATA
                    </button>
                </div>

                <form id="exportForm" th:action="@{/datos-crf/list/exportar}" method="post" style="display: none;">
                    <input type="hidden" id="criteriosExport" name="criteriosJson" />
                    <input type="hidden" id="excludedColsExport" name="excludedColsJson" />
                </form>
                <form id="stataExportForm" th:action="@{/datos-crf/list/exportar-stata}" method="post" style="display: none;">
                    <input type="hidden" id="stataCriteriosExport" name="criteriosJson" />
                    <input type="hidden" id="stataExcludedColsExport" name="excludedColsJson" />
                </form>

                <br> 

                <div class="table-responsive-wrapper" id="drag-container">
                    <table class="tabla-bonita" id="tabla-reporte">
                        <thead>
                            <tr>
                                <th>Cód. Paciente</th>
                                <th th:each="campoStat, stat : ${camposColumnas}"
                                    th:if="${campoStat.campoCrf.tipo != 'TEXTO' and campoStat.campoCrf.tipo != 'FECHA'}"
                                    th:data-col-id="${campoStat.campoCrf.idCampo}"
                                    th:classappend="${stat.index > 0 and campoStat.campoCrf.seccion != camposColumnas[stat.index - 1].campoCrf.seccion} ? 'border-section-start' : ''">
                                    <div class="th-container">
                                        <div class="d-flex align-items-center">
                                            
                                            <i class="ph-bold header-icon" 
                                               th:classappend="${campoStat.campoCrf.seccion == 2 ? 'ph-users' : 
                                                                 campoStat.campoCrf.seccion == 3 ? 'ph-heartbeat' : 
                                                                 campoStat.campoCrf.seccion == 4 ? 'ph-ruler' :
                                                                 campoStat.campoCrf.seccion == 5 ? 'ph-fire' :
                                                                 campoStat.campoCrf.seccion == 6 ? 'ph-brandy' :
                                                                 campoStat.campoCrf.seccion == 7 ? 'ph-carrot' :
                                                                 campoStat.campoCrf.seccion == 8 ? 'ph-virus' :
                                                                 campoStat.campoCrf.seccion == 9 ? 'ph-microscope' : 'ph-question'}"
                                               th:title="|Sección ${campoStat.campoCrf.seccion}|"></i>

                                            <span class="th-text" th:text="${campoStat.campoCrf.nombre}">Nom</span>
                                        </div>
                                        <div class="th-actions">
                                            <button type="button" class="btn-th-action btn-add-criterion" 
                                                    th:data-campo-id="${campoStat.campoCrf.idCampo}"
                                                    th:data-campo-nombre="${campoStat.campoCrf.nombre}"
                                                    th:data-campo-tipo="${campoStat.campoCrf.tipo}" title="Crear variable">
                                                <i class="ph-bold ph-plus"></i>
                                            </button>
                                            <button type="button" class="btn-th-action btn-toggle-col"
                                                    th:data-col-ref="${campoStat.campoCrf.idCampo}" title="Ocultar columna">
                                                <i class="ph-bold ph-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="fila : ${filasCrf}">
                                <td th:text="${fila.crf.datosPaciente?.codigoPaciente}">...</td>
                                <td th:each="campoStat, stat : ${camposColumnas}"
                                    th:if="${campoStat.campoCrf.tipo != 'TEXTO' and campoStat.campoCrf.tipo != 'FECHA'}"
                                    th:data-cell-ref="${campoStat.campoCrf.idCampo}"
                                    th:classappend="${stat.index > 0 and campoStat.campoCrf.seccion != camposColumnas[stat.index - 1].campoCrf.seccion} ? 'border-section-start' : ''">
                                    <span th:text="${fila.valores.get(campoStat.columnaKey) ?: '-'}"></span>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr id="footer-vacios"><td style="text-align: right; padding-right:10px;">Vacíos:</td></tr>
                            <tr id="footer-ceros"><td style="text-align: right; padding-right:10px;">Ceros (0):</td></tr>
                            <tr id="footer-unos"><td style="text-align: right; padding-right:10px;">Unos (1):</td></tr>
                        </tfoot>
                    </table>
                </div>

                <div class="modal fade" id="modalCriterioSimple" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Dicotomizar numérico</h5><button type="button" class="close-modal" data-bs-dismiss="modal">&times;</button></div><div class="modal-body"><h6 id="modalSimpleNombre" style="color: var(--color-primario); margin-bottom: 1rem;"></h6><input type="hidden" id="modalSimpleId" /><div class="form-group mb-3"><label>Criterio</label><select class="form-control" id="selectTipoSimple"><option value="media">Media (Promedio)</option><option value="mediana">Mediana</option><option value="personalizado">Personalizado</option></select></div><div id="divSimplePersonalizado" style="display: none;"><div class="form-group mb-2"><label>Nombre variable</label><input type="text" class="form-control" id="inputSimpleNombreCol"></div><div class="row"><div class="col-6"><label>Operador</label><select class="form-control" id="selectSimpleOperador"><option value=">">Mayor que</option><option value=">=">Mayor igual</option><option value="<">Menor que</option><option value="<=">Menor igual</option><option value="==">Igual</option></select></div><div class="col-6"><label>Punto corte</label><input type="number" class="form-control" id="inputSimpleCorte"></div></div></div></div><div class="modal-footer"><button type="button" class="btn-secundario" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn-primario" id="btnGuardarSimple">Guardar</button></div></div></div></div>
                <div class="modal fade" id="modalCriterioComplejo" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="ph-bold ph-function"></i> Constructor lógico</h5><button type="button" class="close-modal" data-bs-dismiss="modal">&times;</button></div><div class="modal-body" style="background-color: var(--color-fondo);"><input type="hidden" id="modalComplejoIdOrigen" /><div class="logic-header-bar"><div style="flex: 1;"><label class="form-label small fw-bold text-muted mb-1">Nombre nueva variable</label><input type="text" class="form-control" id="inputComplejoNombre" placeholder="Ej: Paciente_Riesgo"></div><div style="flex: 1;"><label class="form-label small fw-bold text-muted mb-1">Lógica entre bloques</label><select class="form-select" id="selectGlobalLogic"><option value="OR">Alguno es verdadero (OR)</option><option value="AND">Todos son verdaderos (AND)</option></select></div></div><div class="logic-container" id="blocks-container"></div><div class="d-flex justify-content-center mt-4 w-100"><button type="button" class="btn btn-outline-primary border-2 fw-bold px-4 py-2" id="btnAddBlock" style="border-color: var(--color-primario); color: var(--color-primario);"><i class="ph-bold ph-plus-circle"></i> Añadir nuevo bloque</button></div></div><div class="modal-footer"><button type="button" class="btn-secundario" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn-primario px-4" id="btnGuardarComplejo">Crear variable</button></div></div></div></div>
                <div class="modal fade" id="modalExcelConfirm" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center"><div class="modal-header border-0 justify-content-center"><i class="ph-bold ph-file-xls text-success" style="font-size: 3.5rem;"></i></div><div class="modal-body"><h3>Confirmar exportación Excel</h3><div id="excel-info-list" class="text-start p-3 rounded mt-2" style="background-color: var(--color-fondo);"></div></div><div class="modal-footer justify-content-center"><button type="button" class="btn-secundario" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn-exito" id="btn-execute-excel">Descargar</button></div></div></div></div>
                <div class="modal fade" id="modalStataPreview" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center"><div class="modal-header border-0 justify-content-center"><i class="ph-bold ph-file-code" style="font-size: 3.5rem; color: #1a60ac;"></i></div><div class="modal-body"><h3>Confirmar exportación STATA</h3><div id="stata-info-list" class="text-start p-3 rounded mt-2" style="background-color: var(--color-fondo);"></div></div><div class="modal-footer justify-content-center"><button type="button" class="btn-secundario" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn-stata" id="btn-confirmar-descarga-stata">Exportar</button></div></div></div></div>

                <div class="modal fade" id="modalConfirmarAccion" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content text-center">
                            <div class="modal-header border-0 justify-content-center">
                                <i class="ph-bold ph-warning-circle" style="font-size: 3.5rem; color: var(--color-aviso);"></i>
                            </div>
                            <div class="modal-body">
                                <h3 id="conf-titulo">¿Está seguro?</h3>
                                <p id="conf-mensaje" class="text-muted">Esta acción no se puede deshacer.</p>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn-secundario" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn-primario" id="btn-confirmar-generico">Sí, Confirmar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="modalConfirmarDesactivarConfig" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content text-center">
                            <div class="modal-header border-0 justify-content-center">
                                <i class="ph-bold ph-floppy-disk-back" style="font-size: 3.5rem; color: var(--color-aviso);"></i>
                            </div>
                            <div class="modal-body">
                                <h3>¿Desactivar guardado automático?</h3>
                                <p class="text-muted" style="margin-top: 1rem;">
                                    Si desactiva esta opción, <strong>se borrarán todas las configuraciones guardadas</strong> (columnas ocultas y variables calculadas) de este navegador.
                                    <br><br>
                                    La próxima vez que entre, verá la tabla original por defecto.
                                </p>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn-secundario" data-bs-dismiss="modal" id="btn-cancelar-desactivacion">Cancelar</button>
                                <button type="button" class="btn-error" id="btn-confirmar-desactivacion">Desactivar y Borrar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                /*<![CDATA[*/
                    document.addEventListener('DOMContentLoaded', () => {
                        const table = document.getElementById('tabla-reporte');
                        const slider = document.getElementById('drag-container');
                        const blocksContainer = document.getElementById('blocks-container');
                        const checkPersistencia = document.getElementById('checkPersistencia');
                        
                        let bsModalSimple, bsModalComplejo, bsModalExcel, bsModalStata, bsModalConfirm, bsModalPersistencia;
                        let criterios = {}; 
                        let excludedCols = new Set(); 
                        let actionToConfirm = null;

                        // ==========================================
                        // 1. CONFIGURACIÓN POR DEFECTO
                        // ==========================================
                        const CONFIG_POR_DEFECTO = {"criterios":{"col-1765572706973":{"nombreColumna":"edad_Media","tipo":"media","puntoCorte":"30","operador":">","origenId":"1"},"col-1765572716560":{"nombreColumna":"edad_Mediana","tipo":"mediana","puntoCorte":"30","operador":">","origenId":"1"},"col-1765572751054":{"nombreColumna":"Edad_50","tipo":"personalizado","puntoCorte":"50","operador":">=","origenId":"1"},"col-1765572765578":{"nombreColumna":"Edad_60","tipo":"personalizado","puntoCorte":"60","operador":">=","origenId":"1"},"col-1765572853068":{"nombreColumna":"Sexo","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"2","operador":"==","valor":"0"}]}],"origenId":"2"},"col-1765573132808":{"nombreColumna":"Residencia_Urbana5a","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"4","operador":"==","valor":"0"},{"campoId":"5","operador":"==","valor":"1"}]},{"logic":"AND","rules":[{"campoId":"4","operador":"==","valor":"1"},{"campoId":"5","operador":"==","valor":"0"}]}],"origenId":"4"},"col-1765573207913":{"nombreColumna":"Residencia_Rural5a","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"4","operador":"==","valor":"1"},{"campoId":"5","operador":"==","valor":"1"}]},{"logic":"AND","rules":[{"campoId":"4","operador":"==","valor":"0"},{"campoId":"5","operador":"==","valor":"0"}]}],"origenId":"4"},"col-1765573306952":{"nombreColumna":"NivelEduc_Basico","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"OR","rules":[{"campoId":"6","operador":"==","valor":"1"},{"campoId":"6","operador":"==","valor":"2"}]}],"origenId":"6"},"col-1765573368701":{"nombreColumna":"NivelEduc_BasicoMedio","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"6","operador":"==","valor":"2"}]}],"origenId":"6"},"col-1765573454203":{"nombreColumna":"Prevision_FonasaVsOtros","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"8","operador":"!=","valor":"0"}]}],"origenId":"8"},"col-1765573476784":{"nombreColumna":"Prevision_IsapreVsOtros","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"8","operador":"!=","valor":"1"}]}],"origenId":"8"},"col-1765573533148":{"nombreColumna":"peso_Media","tipo":"media","puntoCorte":"65","operador":">","origenId":"19"},"col-1765573545519":{"nombreColumna":"peso_Mediana","tipo":"mediana","puntoCorte":"65","operador":">","origenId":"19"},"col-1765573569821":{"nombreColumna":"estatura_Media","tipo":"media","puntoCorte":"1.65","operador":">","origenId":"20"},"col-1765573591562":{"nombreColumna":"estatura_Mediana","tipo":"mediana","puntoCorte":"1.65","operador":">","origenId":"20"},"col-1765573611510":{"nombreColumna":"imc_Media","tipo":"media","puntoCorte":"23.799999999999997","operador":">","origenId":"21"},"col-1765573615876":{"nombreColumna":"imc_Mediana","tipo":"mediana","puntoCorte":"23.799999999999997","operador":">","origenId":"21"},"col-1765573680082":{"nombreColumna":"IMC_Menor25","tipo":"personalizado","puntoCorte":"25","operador":">=","origenId":"21"},"col-1765573819433":{"nombreColumna":"tabaco_nunca_vs_otros","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"!=","valor":"0"}]}],"origenId":"22"},"col-1765574019170":{"nombreColumna":"tabaco_actual_o_reciente","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"1"},{"campoId":"25","operador":"!=","valor":"2"}]}],"origenId":"22"},"col-1765574111886":{"nombreColumna":"tabaco_reciente_agudo","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"1"},{"campoId":"25","operador":"==","valor":"0"}]}],"origenId":"22"},"col-1765574380110":{"nombreColumna":"tabaco_moderada_carga","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"23","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"23","operador":"!=","valor":"2"},{"campoId":"24","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"1"},{"campoId":"25","operador":"!=","valor":"2"}]}],"origenId":"22"},"col-1765574593204":{"nombreColumna":"tabaco_grave_carga","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"23","operador":"!=","valor":"0"},{"campoId":"24","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"23","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"1"},{"campoId":"25","operador":"!=","valor":"2"}]}],"origenId":"22"},"col-1765574654090":{"nombreColumna":"tabaco_cronico","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"24","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"1"}]}],"origenId":"22"},"col-1765574699632":{"nombreColumna":"tabaco_leve_cronico","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"23","operador":"==","valor":"0"},{"campoId":"24","operador":"==","valor":"0"}]}],"origenId":"22"},"col-1765575026128":{"nombreColumna":"tabaco_reciente_alta_carga","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"23","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"2"},{"campoId":"23","operador":"!=","valor":"0"},{"campoId":"24","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"1"},{"campoId":"25","operador":"==","valor":"0"},{"campoId":"23","operador":"!=","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"22","operador":"==","valor":"1"},{"campoId":"25","operador":"==","valor":"0"},{"campoId":"24","operador":"!=","valor":"0"}]}],"origenId":"22"},"col-1765575191556":{"nombreColumna":"alcohol_alguna_vez","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"!=","valor":"0"}]}],"origenId":"26"},"col-1765575239735":{"nombreColumna":"alcohol_actual_o_reciente","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"1"},{"campoId":"30","operador":"!=","valor":"2"}]}],"origenId":"26"},"col-1765575295212":{"nombreColumna":"alcohol_reciente_agudo","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"1"},{"campoId":"30","operador":"==","valor":"0"}]}],"origenId":"26"},"col-1765575567118":{"nombreColumna":"alcohol_moderada_carga","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"27","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"28","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"29","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"1"},{"campoId":"30","operador":"!=","valor":"2"}]}],"origenId":"26"},"col-1765575709836":{"nombreColumna":"alcohol_grave_carga","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"28","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"28","operador":"==","valor":"1"},{"campoId":"29","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"27","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"1"},{"campoId":"30","operador":"!=","valor":"2"}]}],"origenId":"26"},"col-1765575758265":{"nombreColumna":"alcohol_cronico","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"29","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"1"}]}],"origenId":"26"},"col-1765575860421":{"nombreColumna":"alcohol_leve_cronico","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"27","operador":"!=","valor":"2"},{"campoId":"28","operador":"==","valor":"0"},{"campoId":"29","operador":"==","valor":"0"}]}],"origenId":"26"},"col-1765575993277":{"nombreColumna":"alcohol_intenso_reciente","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"28","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"2"},{"campoId":"27","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"1"},{"campoId":"30","operador":"==","valor":"0"},{"campoId":"28","operador":"==","valor":"2"}]},{"logic":"AND","rules":[{"campoId":"26","operador":"==","valor":"1"},{"campoId":"30","operador":"==","valor":"0"},{"campoId":"27","operador":"==","valor":"2"}]}],"origenId":"26"},"col-1765576160159":{"nombreColumna":"CarnesProcesadas_Menos3","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"31","operador":"==","valor":"2"}]}],"origenId":"31"},"col-1765576199244":{"nombreColumna":"CarnesProcesadas_Max1","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"31","operador":"!=","valor":"0"}]}],"origenId":"31"},"col-1765576253923":{"nombreColumna":"FrutasVerduras_3oMas","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"33","operador":"==","valor":"2"}]}],"origenId":"33"},"col-1765576279314":{"nombreColumna":"FrutasVerduras_5oMas","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"33","operador":"!=","valor":"0"}]}],"origenId":"33"},"col-1765576324770":{"nombreColumna":"CondimentosFrecAlta","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"35","operador":"==","valor":"2"}]}],"origenId":"35"},"col-1765576350678":{"nombreColumna":"CondimentosCualquierConsumo","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"35","operador":"!=","valor":"0"}]}],"origenId":"35"},"col-1765576376432":{"nombreColumna":"BebidasCalientes_AltaFrecuencia","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"36","operador":"==","valor":"2"}]}],"origenId":"36"},"col-1765576397155":{"nombreColumna":"BebidasCalientes_CualquierConsumo","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"36","operador":"!=","valor":"0"}]}],"origenId":"36"},"col-1765576597749":{"nombreColumna":"FuenteYTratamientoAgua","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"41","operador":"!=","valor":"0"},{"campoId":"43","operador":"==","valor":"0"}]}],"origenId":"41"},"col-1765576641104":{"nombreColumna":"Lena_Frecuente","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"40","operador":"==","valor":"2"}]}],"origenId":"40"},"col-1765576655586":{"nombreColumna":"Lena_AlgunaExposicion","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"40","operador":"!=","valor":"0"}]}],"origenId":"40"},"col-1765576715816":{"nombreColumna":"HPylori_AlgunaVezPositivo","tipo":"complejo","globalLogic":"OR","bloques":[{"logic":"AND","rules":[{"campoId":"44","operador":"==","valor":"0"}]},{"logic":"AND","rules":[{"campoId":"45","operador":"==","valor":"0"}]}],"origenId":"44"}},"excludedCols":["2","4","5","6","22","23","25","24","29","28","26","27","30","35","36","31","33","40","43","41","53","44","45","46","48","49","55","57","51","54","60","58"]};

                        function init() {
                            const loader = document.getElementById('loading-overlay');

                            // Usamos setTimeout para asegurar que el loader se renderice
                            // antes de ejecutar la lógica pesada
                            setTimeout(() => {
                                try {
                                    if (typeof bootstrap !== 'undefined') {
                                        bsModalSimple = new bootstrap.Modal(document.getElementById('modalCriterioSimple'));
                                        bsModalComplejo = new bootstrap.Modal(document.getElementById('modalCriterioComplejo'));
                                        bsModalExcel = new bootstrap.Modal(document.getElementById('modalExcelConfirm'));
                                        bsModalStata = new bootstrap.Modal(document.getElementById('modalStataPreview'));
                                        bsModalConfirm = new bootstrap.Modal(document.getElementById('modalConfirmarAccion'));
                                        bsModalPersistencia = new bootstrap.Modal(document.getElementById('modalConfirmarDesactivarConfig'));
                                    }
                                    
                                    // --- LÓGICA DE PROCESAMIENTO (QUE PUEDE TARDAR) ---
                                    normalizarTablaANumeros();
                                    
                                    // CARGAR CONFIGURACIÓN (PERSISTENTE O DEFECTO)
                                    cargarConfiguracion(); 
                                    
                                    calcularResumenes();
                                    initDragAndDrop();
                                    initColumnControls();
                                    
                                    document.getElementById('selectTipoSimple').addEventListener('change', function() {
                                        const div = document.getElementById('divSimplePersonalizado');
                                        div.style.display = this.value === 'personalizado' ? 'block' : 'none';
                                    });

                                    // --- LÓGICA CONFIRMACIÓN PERSISTENCIA ---
                                    checkPersistencia.addEventListener('click', function(e) {
                                        if (!this.checked) {
                                            e.preventDefault();
                                            bsModalPersistencia.show();
                                        } else {
                                            activarPersistencia();
                                        }
                                    });

                                    document.getElementById('btn-confirmar-desactivacion').onclick = function() {
                                        desactivarPersistencia();
                                        bsModalPersistencia.hide();
                                    };
                                    
                                    document.getElementById('btn-cancelar-desactivacion').onclick = function() {
                                        checkPersistencia.checked = true;
                                        bsModalPersistencia.hide();
                                    };

                                } catch(e) { 
                                    console.error("Error init", e); 
                                } finally {
                                    // --- OCULTAR LOADER AL FINALIZAR ---
                                    if(loader) {
                                        loader.classList.add('loader-hidden');
                                        // Opcional: Eliminar del DOM después de la transición
                                        setTimeout(() => loader.remove(), 500);
                                    }
                                }
                            }, 100); 
                        }

                        // --- MÉTODOS PERSISTENCIA ---
                        function activarPersistencia() {
                            checkPersistencia.checked = true;
                            localStorage.setItem('persist_config_enabled', 'true');
                            guardarConfiguracion();
                            if(typeof showToast === 'function') showToast("Configuración se guardará automáticamente", "success");
                        }

                        function desactivarPersistencia() {
                            checkPersistencia.checked = false;
                            localStorage.removeItem('persist_config_enabled');
                            localStorage.removeItem('polygen_config_datos');
                            if(typeof showToast === 'function') showToast("Configuración olvidada", "info");
                        }

                        function guardarConfiguracion() {
                            if(!checkPersistencia.checked) return;
                            const config = {
                                criterios: criterios,
                                excludedCols: Array.from(excludedCols)
                            };
                            localStorage.setItem('polygen_config_datos', JSON.stringify(config));
                        }

                        function cargarConfiguracion() {
                            const isEnabled = localStorage.getItem('persist_config_enabled') === 'true';
                            checkPersistencia.checked = isEnabled;
                            
                            let config = null;

                            // 1. Intentar cargar del localStorage
                            if (isEnabled) {
                                const saved = localStorage.getItem('polygen_config_datos');
                                if (saved) {
                                    try { config = JSON.parse(saved); } catch(e) {}
                                }
                            }

                            // 2. Si no hay nada, usar DEFAULT
                            if (!config && CONFIG_POR_DEFECTO) {
                                console.log("Cargando configuración por defecto...");
                                config = CONFIG_POR_DEFECTO;
                            }

                            // 3. Aplicar
                            if (config) {
                                criterios = config.criterios || {};
                                excludedCols = new Set(config.excludedCols || []);
                                
                                // Restaurar exclusiones visuales
                                excludedCols.forEach(colRef => {
                                    const th = document.querySelector(`th[data-col-id="${colRef}"]`);
                                    if(th) {
                                        th.classList.add('col-excluded-header');
                                        const icon = th.querySelector('i.ph-eye'); 
                                        if(icon) icon.classList.replace('ph-eye', 'ph-eye-slash');
                                        document.querySelectorAll(`td[data-cell-ref="${colRef}"]`).forEach(td => td.classList.add('col-excluded'));
                                    }
                                });

                                // Restaurar columnas calculadas
                                for(const uuid in criterios) {
                                    const crit = criterios[uuid];
                                    if(crit.origenId) agregarColumnaDOM(crit.origenId, uuid, crit);
                                }
                            }
                        }

                        // --- UTILIDADES ---
                        function obtenerValoresColumna(colId) {
                            const headers = Array.from(table.querySelectorAll('thead th'));
                            const colIdx = headers.findIndex(th => th.dataset.colId == colId);
                            if (colIdx === -1) return [];
                            const valores = [];
                            table.querySelectorAll('tbody tr').forEach(row => {
                                const valStr = row.children[colIdx].innerText.trim();
                                if (valStr && valStr !== '-') {
                                    const num = parseFloat(valStr.replace(',', '.'));
                                    if (!isNaN(num)) valores.push(num);
                                }
                            });
                            return valores;
                        }

                        function calcularEstadistico(valores, tipo) {
                            if (valores.length === 0) return 0;
                            if (tipo === 'media') {
                                const sum = valores.reduce((a, b) => a + b, 0);
                                return sum / valores.length;
                            } else if (tipo === 'mediana') {
                                valores.sort((a, b) => a - b);
                                const mid = Math.floor(valores.length / 2);
                                return valores.length % 2 !== 0 ? valores[mid] : (valores[mid - 1] + valores[mid]) / 2;
                            }
                            return 0;
                        }

                        function normalizarTablaANumeros() {
                            const headers = Array.from(table.querySelectorAll('thead th'));
                            const rows = table.querySelectorAll('tbody tr');
                            const colIndexToId = {};
                            headers.forEach((th, idx) => { if(th.dataset.colId) colIndexToId[idx] = "" + th.dataset.colId; });

                            rows.forEach(row => {
                                for (const [index, campoId] of Object.entries(colIndexToId)) {
                                    const celda = row.children[index];
                                    const val = celda.innerText.trim();
                                    const meta = fieldsMetadata[campoId];
                                    if (!val || val === '-') continue;
                                    if (meta) {
                                        if (meta.tipo === 'SI/NO') {
                                            if (['sí','si','yes','s'].includes(val.toLowerCase())) celda.innerText = "1";
                                            else if (['no','n'].includes(val.toLowerCase())) celda.innerText = "0";
                                        } else if (meta.tipo === 'SELECCION_UNICA' && meta.opciones) {
                                            const op = meta.opciones.find(o => o.text.toLowerCase() === val.toLowerCase());
                                            if (op) celda.innerText = op.val;
                                        }
                                    }
                                }
                            });
                        }

                        function calcularResumenes() {
                            const rowVacios = document.getElementById('footer-vacios');
                            const rowCeros = document.getElementById('footer-ceros');
                            const rowUnos = document.getElementById('footer-unos');
                            while(rowVacios.children.length > 1) rowVacios.removeChild(rowVacios.lastChild);
                            while(rowCeros.children.length > 1) rowCeros.removeChild(rowCeros.lastChild);
                            while(rowUnos.children.length > 1) rowUnos.removeChild(rowUnos.lastChild);

                            const headers = Array.from(table.querySelectorAll('thead th'));
                            const rows = table.querySelectorAll('tbody tr');

                            for (let i = 1; i < headers.length; i++) {
                                let vacios = 0, ceros = 0, unos = 0;
                                rows.forEach(row => {
                                    const val = row.children[i].innerText.trim();
                                    if(!val || val === '-') vacios++;
                                    else if(val === '0' || val === '0.0') ceros++;
                                    else if(val === '1' || val === '1.0') unos++;
                                });
                                const createCell = (val) => { 
                                    const td = document.createElement('td'); td.innerText = val; td.style.textAlign = 'center'; return td; 
                                };
                                rowVacios.appendChild(createCell(vacios));
                                rowCeros.appendChild(createCell(ceros));
                                rowUnos.appendChild(createCell(unos));
                            }
                        }

                        function initDragAndDrop() {
                            let isDown = false; let startX, scrollLeft;
                            slider.addEventListener('mousedown', (e) => {
                                if(e.target.closest('button, input, select')) return;
                                isDown = true; slider.classList.add('grabbing');
                                startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft;
                            });
                            slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('grabbing'); });
                            slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('grabbing'); });
                            slider.addEventListener('mousemove', (e) => {
                                if (!isDown) return; e.preventDefault();
                                const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 1.5;
                                slider.scrollLeft = scrollLeft - walk;
                            });
                        }

                        function initColumnControls() {
                            document.addEventListener('click', (e) => {
                                const btnAdd = e.target.closest('.btn-add-criterion');
                                if (btnAdd) {
                                    const tipo = btnAdd.dataset.campoTipo;
                                    const id = btnAdd.dataset.campoId;
                                    const nom = btnAdd.dataset.campoNombre;
                                    if (tipo === 'NUMERO') {
                                        document.getElementById('modalSimpleId').value = id;
                                        document.getElementById('modalSimpleNombre').innerText = nom;
                                        bsModalSimple.show();
                                    } else {
                                        document.getElementById('modalComplejoIdOrigen').value = id;
                                        document.getElementById('inputComplejoNombre').value = '';
                                        blocksContainer.innerHTML = '';
                                        createBlock(0, id); 
                                        bsModalComplejo.show();
                                    }
                                }

                                const btnEye = e.target.closest('.btn-toggle-col');
                                if (btnEye) {
                                    const colRef = btnEye.dataset.colRef;
                                    const isExcluded = excludedCols.has(colRef);
                                    const icon = btnEye.querySelector('i');
                                    const th = btnEye.closest('th');
                                    th.classList.toggle('col-excluded-header');
                                    if (!isExcluded) { excludedCols.add(colRef); icon.classList.replace('ph-eye', 'ph-eye-slash'); } 
                                    else { excludedCols.delete(colRef); icon.classList.replace('ph-eye-slash', 'ph-eye'); }
                                    const cells = document.querySelectorAll(`td[data-cell-ref="${colRef}"], td[data-uuid="${colRef}"]`);
                                    cells.forEach(td => td.classList.toggle('col-excluded'));
                                    guardarConfiguracion(); // SAVE STATE
                                }

                                const btnTrash = e.target.closest('.btn-delete-col');
                                if (btnTrash) {
                                    // REEMPLAZO DE CONFIRM
                                    actionToConfirm = () => {
                                        const uuid = btnTrash.dataset.colRef;
                                        delete criterios[uuid];
                                        excludedCols.delete(uuid);
                                        const th = document.querySelector(`th[data-uuid="${uuid}"]`);
                                        if(th) {
                                            const colIdx = Array.from(th.parentNode.children).indexOf(th);
                                            th.remove();
                                            table.querySelectorAll('tbody tr').forEach(tr => { if(tr.children[colIdx]) tr.children[colIdx].remove(); });
                                            calcularResumenes();
                                            guardarConfiguracion(); // SAVE STATE
                                        }
                                        bsModalConfirm.hide();
                                    };
                                    document.getElementById('conf-titulo').innerText = '¿Eliminar Variable?';
                                    document.getElementById('conf-mensaje').innerText = 'Se eliminará esta columna calculada.';
                                    bsModalConfirm.show();
                                }
                            });
                        }

                        // --- GUARDAR SIMPLE ---
                        document.getElementById('btnGuardarSimple').onclick = () => {
                            const idOrigen = document.getElementById('modalSimpleId').value;
                            const tipo = document.getElementById('selectTipoSimple').value;
                            const uuid = 'col-' + Date.now();
                            const valores = obtenerValoresColumna(idOrigen);
                            let corte = 0, operador = '>', nombreCol = '';

                            if (tipo === 'media' || tipo === 'mediana') {
                                corte = calcularEstadistico(valores, tipo);
                                operador = '>';
                                nombreCol = fieldsMetadata[idOrigen].nombre + '_' + (tipo === 'media' ? 'Media' : 'Mediana');
                            } else {
                                corte = parseFloat(document.getElementById('inputSimpleCorte').value || 0);
                                operador = document.getElementById('selectSimpleOperador').value;
                                const nombreUser = document.getElementById('inputSimpleNombreCol').value;
                                nombreCol = nombreUser ? nombreUser : (fieldsMetadata[idOrigen].nombre + '_Corte');
                            }

                            const config = { nombreColumna: nombreCol, tipo: tipo, puntoCorte: corte.toString(), operador: operador, origenId: idOrigen };
                            criterios[uuid] = config;
                            agregarColumnaDOM(idOrigen, uuid, config);
                            bsModalSimple.hide();
                            guardarConfiguracion(); // SAVE STATE
                        };

                        // --- GUARDAR COMPLEJO ---
                        document.getElementById('btnGuardarComplejo').onclick = () => {
                            const nombre = document.getElementById('inputComplejoNombre').value.trim();
                            const globalLogic = document.getElementById('selectGlobalLogic').value; 
                            if(!nombre) { 
                                // REEMPLAZO DE ALERT
                                if(typeof showToast === 'function') showToast("Ingrese un nombre para la variable", "error");
                                else alert("Ingrese nombre"); 
                                return;
                            }

                            const bloques = [];
                            document.querySelectorAll('.logic-card').forEach(card => {
                                const logicSelector = card.querySelector('.logic-select');
                                const logicType = logicSelector ? (logicSelector.classList.contains('and') ? 'AND' : 'OR') : 'AND'; 
                                const reglas = [];
                                card.querySelectorAll('.rule-row').forEach(row => {
                                    const fieldId = row.querySelector('.rule-field').value;
                                    const op = row.querySelector('.rule-op').value;
                                    const valEl = row.querySelector('.rule-val').querySelector('input, select');
                                    if(valEl) reglas.push({ campoId: fieldId, operador: op, valor: valEl.value });
                                });
                                if(reglas.length > 0) bloques.push({ logic: logicType, rules: reglas });
                            });

                            if(bloques.length === 0) return;
                            const uuid = 'col-' + Date.now();
                            const idOrigen = document.getElementById('modalComplejoIdOrigen').value;
                            const config = { nombreColumna: nombre, tipo: 'complejo', globalLogic: globalLogic, bloques: bloques, origenId: idOrigen };
                            criterios[uuid] = config;
                            agregarColumnaDOM(idOrigen, uuid, config);
                            bsModalComplejo.hide();
                            guardarConfiguracion(); // SAVE STATE
                        };

                        // --- LOGIC BLOQUES & CONFIRMACIÓN ---
                        document.getElementById('btn-confirmar-generico').onclick = () => {
                            if(actionToConfirm) actionToConfirm();
                        };

                        function createBlock(idx, defaultFieldId) {
                            const card = document.createElement('div');
                            card.className = 'logic-card';
                            const header = document.createElement('div');
                            header.className = 'logic-card-header';
                            header.innerHTML = `<span style="font-weight: bold; color: var(--color-texto-secundario);">Bloque #${idx + 1}</span>`;
                            const selectLogic = document.createElement('select');
                            selectLogic.className = 'logic-select and';
                            selectLogic.innerHTML = '<option value="AND">Cumplir todas (AND)</option><option value="OR">Cumplir alguna (OR)</option>';
                            selectLogic.onchange = () => { selectLogic.className = selectLogic.value === 'AND' ? 'logic-select and' : 'logic-select or'; };
                            const controlsDiv = document.createElement('div');
                            controlsDiv.style.display = 'flex'; controlsDiv.style.gap = '10px'; controlsDiv.style.alignItems = 'center';
                            if(idx > 0) {
                                const btnClose = document.createElement('button');
                                btnClose.className = 'btn-error btn-sm';
                                btnClose.innerHTML = '<i class="ph-bold ph-trash"></i>';
                                btnClose.onclick = () => card.remove();
                                controlsDiv.appendChild(selectLogic); controlsDiv.appendChild(btnClose);
                            } else controlsDiv.appendChild(selectLogic);
                            header.appendChild(controlsDiv);
                            const rulesContainer = document.createElement('div');
                            rulesContainer.className = 'logic-card-body';
                            rulesContainer.appendChild(createRuleRow(defaultFieldId)); 
                            const footerDiv = document.createElement('div');
                            footerDiv.className = 'd-flex justify-content-center mt-2 w-100';
                            const btnAddRule = document.createElement('button');
                            btnAddRule.className = 'btn-subtle btn-sm';
                            btnAddRule.style.borderRadius = '20px';
                            btnAddRule.innerHTML = '<i class="ph-bold ph-plus"></i> Añadir otra regla';
                            btnAddRule.onclick = () => rulesContainer.appendChild(createRuleRow());
                            footerDiv.appendChild(btnAddRule);
                            card.append(header, rulesContainer, footerDiv);
                            blocksContainer.appendChild(card);
                        }

                        function createRuleRow(preselectedId) {
                            const row = document.createElement('div');
                            row.className = 'rule-row';
                            const selField = document.createElement('select');
                            selField.className = 'form-select form-select-sm rule-field';
                            for(const id in fieldsMetadata) {
                                const f = fieldsMetadata[id];
                                const opt = document.createElement('option');
                                opt.value = f.id; opt.text = f.nombre;
                                if(String(f.id) === String(preselectedId)) opt.selected = true;
                                selField.appendChild(opt);
                            }
                            const selOp = document.createElement('select');
                            selOp.className = 'form-select form-select-sm rule-op';
                            const valContainer = document.createElement('div');
                            valContainer.className = 'rule-val';
                            const updateUI = () => {
                                const meta = fieldsMetadata[selField.value];
                                valContainer.innerHTML = '';
                                selOp.innerHTML = '';
                                if(meta.tipo === 'NUMERO' || meta.tipo === 'FECHA') {
                                    selOp.innerHTML = `<option value="==">Igual (=)</option><option value="!=">Diferente (!=)</option><option value=">">Mayor (&gt;)</option><option value="<">Menor (&lt;)</option><option value=">=">Mayor o igual</option><option value="<=">Menor o igual</option>`;
                                    const inp = document.createElement('input');
                                    inp.type = meta.tipo === 'FECHA' ? 'date' : 'number';
                                    inp.className = 'form-control form-control-sm';
                                    valContainer.appendChild(inp);
                                } else {
                                    selOp.innerHTML = `<option value="==">Igual a</option><option value="!=">Diferente de</option>`;
                                    if(meta.tipo === 'SI/NO') {
                                        const sel = document.createElement('select');
                                        sel.className = 'form-select form-select-sm';
                                        sel.innerHTML = '<option value="1">Sí (1)</option><option value="0">No (0)</option>';
                                        valContainer.appendChild(sel);
                                    } else if(meta.tipo === 'SELECCION_UNICA' && meta.opciones.length > 0) {
                                        const sel = document.createElement('select');
                                        sel.className = 'form-select form-select-sm';
                                        meta.opciones.forEach(o => { sel.innerHTML += `<option value="${o.val}">${o.text}</option>`; });
                                        valContainer.appendChild(sel);
                                    } else {
                                        selOp.innerHTML += `<option value="contains">Contiene texto</option>`;
                                        const inp = document.createElement('input');
                                        inp.type = 'text'; inp.className = 'form-control form-control-sm';
                                        valContainer.appendChild(inp);
                                    }
                                }
                            };
                            selField.addEventListener('change', updateUI);
                            updateUI(); 
                            const btnDel = document.createElement('button');
                            btnDel.className = 'btn-error btn-sm';
                            btnDel.style.padding = '2px 6px';
                            btnDel.innerHTML = '<i class="ph-bold ph-x"></i>';
                            btnDel.onclick = () => row.remove();
                            row.append(selField, selOp, valContainer, btnDel);
                            return row;
                        }

                        document.getElementById('btnAddBlock').onclick = () => {
                            const count = blocksContainer.querySelectorAll('.logic-card').length;
                            createBlock(count);
                        };

                        // RENDERING Y PREPARACIÓN
                        function agregarColumnaDOM(idOrigen, uuid, config) {
                            const headers = Array.from(table.querySelectorAll('thead th'));
                            const refHeader = headers.find(th => th.dataset.colId == idOrigen);
                            if(!refHeader) return; // Si la columna base no existe (ej. fue borrada), no restaurar

                            const th = document.createElement('th');
                            th.dataset.uuid = uuid;
                            th.style.backgroundColor = 'var(--color-fondo)';
                            th.style.borderLeft = '2px solid var(--color-primario)';
                            th.style.borderBottom = '2px solid var(--color-borde)';
                            th.innerHTML = `
                                <div class="th-container">
                                    <span class="th-text" style="color:var(--color-primario); font-weight:bold;">${config.nombreColumna}</span>
                                    <div class="th-actions">
                                        <button class="btn-th-action btn-delete-col trash" data-col-ref="${uuid}"><i class="ph-bold ph-trash"></i></button>
                                        <button class="btn-th-action btn-toggle-col" data-col-ref="${uuid}"><i class="ph-bold ph-eye"></i></button>
                                    </div>
                                </div>`;
                            refHeader.after(th);

                            const rows = table.querySelectorAll('tbody tr');
                            const colMap = {}; 
                            Array.from(table.querySelectorAll('thead th')).forEach((h, i) => { if(h.dataset.colId) colMap[h.dataset.colId] = i; });

                            rows.forEach(row => {
                                let res = 0;
                                if (config.tipo === 'media' || config.tipo === 'mediana' || config.tipo === 'personalizado') {
                                    const celdaOrigen = row.children[colMap[config.origenId]];
                                    const val = celdaOrigen ? celdaOrigen.innerText.trim() : '-';
                                    const numVal = parseFloat(val.replace(',', '.'));
                                    const corte = parseFloat(config.puntoCorte);
                                    if (!isNaN(numVal)) res = evalRule(numVal, config.operador, corte) ? 1 : 0;
                                    else res = '-';
                                } else if(config.bloques) {
                                    let isMissing = false;

                                    const results = config.bloques.map(block => {
                                        // 1. Evaluar cada regla individualmente
                                        const ruleResults = block.rules.map(r => {
                                            const cell = row.children[colMap[r.campoId]];
                                            const val = cell ? cell.innerText.trim() : '-';
                                            
                                            // Si falta un dato, marcamos que el resultado es invalido/faltante
                                            if (!val || val === '-' || val === '') {
                                                isMissing = true;
                                                return false; 
                                            }
                                            return evalRule(val, r.operador, r.valor);
                                        });

                                        // 2. Aplicar lógica del bloque (AND/OR)
                                        if (block.logic === 'AND') {
                                            return ruleResults.every(r => r === true);
                                        } else { 
                                            return ruleResults.some(r => r === true);
                                        }
                                    });

                                    // 3. Resultado Final: Si faltaba algún dato, mostramos '-', si no, calculamos 1 o 0
                                    if (isMissing) {
                                        res = '-';
                                    } else {
                                        if (config.globalLogic === 'AND') {
                                            res = results.every(r => r === true) ? 1 : 0;
                                        } else {
                                            res = results.some(r => r === true) ? 1 : 0;
                                        }
                                    }
                                }
                                const td = document.createElement('td');
                                td.dataset.uuid = uuid;
                                td.innerText = res;
                                td.style.textAlign = 'center';
                                td.style.fontWeight = 'bold';
                                td.style.backgroundColor = 'var(--color-fondo)';
                                td.style.borderLeft = '2px solid var(--color-primario)';
                                td.style.color = 'var(--color-texto)';
                                const refIdx = Array.from(refHeader.parentNode.children).indexOf(refHeader);
                                row.children[refIdx].after(td);
                            });
                            calcularResumenes();
                        }

                        function evalRule(val, op, target) {
                            if(val === null || val === undefined || val === '-') return false;
                            let nVal = val, nTarget = target;
                            if (typeof val === 'string') nVal = parseFloat(val);
                            if (typeof target === 'string') nTarget = parseFloat(target);
                            const isNum = !isNaN(nVal) && !isNaN(nTarget);
                            if (op === '==') return isNum ? nVal == nTarget : val == target;
                            if (op === '!=') return isNum ? nVal != nTarget : val != target;
                            if (op === '>') return isNum && nVal > nTarget;
                            if (op === '<') return isNum && nVal < nTarget;
                            if (op === '>=') return isNum && nVal >= nTarget;
                            if (op === '<=') return isNum && nVal <= nTarget;
                            if (op === 'contains') return val.toString().toLowerCase().includes(target.toString().toLowerCase());
                            return false;
                        }

                        function prepararExportacion() {
                            const listDiv = document.getElementById('excel-info-list');
                            listDiv.innerHTML = '';
                            if(excludedCols.size > 0) {
                                listDiv.innerHTML += `<strong>Excluidas (${excludedCols.size}):</strong> <br>`;
                                excludedCols.forEach(id => {
                                    const meta = fieldsMetadata[id];
                                    const name = meta ? meta.nombre : (criterios[id] ? criterios[id].nombreColumna : id);
                                    listDiv.innerHTML += `<span class="badge bg-secondary me-1">${name}</span>`;
                                });
                            } else {
                                listDiv.innerHTML += 'Todas las columnas visibles serán exportadas.';
                            }
                            document.getElementById('criteriosExport').value = JSON.stringify(criterios);
                            document.getElementById('excludedColsExport').value = JSON.stringify(Array.from(excludedCols));
                            document.getElementById('stata-info-list').innerHTML = listDiv.innerHTML;
                            document.getElementById('stataCriteriosExport').value = JSON.stringify(criterios);
                            document.getElementById('stataExcludedColsExport').value = JSON.stringify(Array.from(excludedCols));
                        }

                        document.getElementById('btn-excel-confirm').onclick = () => { prepararExportacion(); bsModalExcel.show(); };
                        document.getElementById('btn-execute-excel').onclick = () => { document.getElementById('exportForm').submit(); bsModalExcel.hide(); };
                        document.getElementById('btn-stata-preview').onclick = () => { prepararExportacion(); bsModalStata.show(); };
                        document.getElementById('btn-confirmar-descarga-stata').onclick = () => { document.getElementById('stataExportForm').submit(); bsModalStata.hide(); };

                        init();
                    });
                /*]]>*/
                </script>
            </div>
        </div>
    </div>
</body>
</html>
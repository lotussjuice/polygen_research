<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main-layout :: ~{}}">

<div th:fragment="contenido">

    <form th:action="@{/crf/guardar}" th:object="${crfForm}" method="post" id="crfFormulario">

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <input type="hidden" th:field="*{idCrf}" />

        <div class="card">
            <div class="card-header">
                <h3><i class="ph-bold ph-user-plus"></i> 1. Datos del Paciente</h3>
            </div>
            <div class="card-body">

                <div class="grid-2">
                    <div class="form-group">
                        <label for="codigoPaciente">Código</label>
                        <input type="text" class="form-control" id="codigoPaciente"
                            th:field="*{datosPaciente.codigoPaciente}" required>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" class="form-control" id="nombre" th:field="*{datosPaciente.nombre}" required>
                    </div>
                    <div class="form-group">
                        <label for="apellido">Apellido</label>
                        <input type="text" class="form-control" id="apellido" th:field="*{datosPaciente.apellido}"
                            required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="numero">Número Contacto</label>
                    <input type="text" class="form-control" id="numero" th:field="*{datosPaciente.numero}">
                </div>
                <div class="form-group">
                    <label for="direccion">Dirección</label>
                    <input type="text" class="form-control" id="direccion" th:field="*{datosPaciente.direccion}">
                </div>

                <input type="hidden" th:field="*{datosPaciente.estado}">
            </div>
        </div>

        <div class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3><i class="ph-bold ph-clipboard-text"></i> 2. Datos del Estudio (CRF)</h3>
            </div>
            <div class="card-body">

                <label>
                    <input type="radio" th:field="*{esCasoEstudio}" th:value="false" required> Caso Control
                </label>
                <label>
                    <input type="radio" th:field="*{esCasoEstudio}" th:value="true" required> Caso Estudio
                </label>

                <div class="form-group" style="margin-top: 1rem;">
                    <label for="observacion">Observaciones</label>

                    <div id="modalConfirmarGuardado" class="modal" style="display: none;">
                        <div class="modal-content"
                            style="max-width: 700px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">

                            <div class="modal-header" style="flex-shrink: 0;">
                                <h2><i class="ph-bold ph-check-circle"></i> Confirmar Guardado</h2>
                                <span class="close-modal" onclick="cerrarModalConfirmacion()">&times;</span>
                            </div>

                            <div class="modal-body" style="overflow-y: auto; padding: 1.5rem;">
                                <div class="alert"
                                    style="background-color: var(--color-fondo); color: var(--color-texto-secundario); margin-bottom: 1rem;">
                                    Revise los datos a continuación. Si todo está correcto, presione "Confirmar y
                                    Guardar".
                                </div>

                                <div class="detail-section"
                                    style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                                    <h4 style="color: var(--color-primario); margin-bottom: 0.5rem;">Datos del Paciente
                                    </h4>
                                    <div class="patient-data-grid"> <strong>Código:</strong> <span
                                            id="preview-codigo"></span>
                                        <strong>Nombre:</strong> <span id="preview-nombre"></span>
                                        <strong>Apellido:</strong> <span id="preview-apellido"></span>
                                        <strong>Teléfono:</strong> <span id="preview-numero"></span>
                                    </div>
                                </div>

                                <div class="detail-section"
                                    style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-borde); padding-bottom: 1rem;">
                                    <h4 style="color: var(--color-primario); margin-bottom: 0.5rem;">Datos del Estudio
                                    </h4>
                                    <p><strong>Tipo:</strong> <span id="preview-tipo"></span></p>
                                    <p><strong>Observaciones:</strong></p>
                                    <p id="preview-obs"
                                        style="white-space: pre-wrap; font-style: italic; color: var(--color-texto-secundario); margin-left: 1rem;">
                                    </p>
                                </div>

                                <div class="detail-section">
                                    <h4 style="color: var(--color-primario); margin-bottom: 1rem;">Respuestas CRF</h4>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: var(--color-fondo);">
                                                <th style="padding: 0.5rem; text-align: left;">Pregunta</th>
                                                <th style="padding: 0.5rem; text-align: left;">Respuesta</th>
                                            </tr>
                                        </thead>
                                        <tbody id="preview-tabla-cuerpo">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="modal-footer" style="flex-shrink: 0;">
                                <div class="btn-group-equal">
                                    <button type="button" class="btn-secundario" onclick="cerrarModalConfirmacion()">
                                        <i class="ph-bold ph-pencil-simple" style="margin-right: 5px;"></i> Seguir
                                        Editando
                                    </button>
                                    <button type="button" class="btn-primario" onclick="enviarFormularioReal()">
                                        <i class="ph-bold ph-floppy-disk" style="margin-right: 5px;"></i> Confirmar y
                                        Guardar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-wrapper">
                        <textarea class="form-control" id="observacion" th:field="*{observacion}" rows="4"
                            maxlength="250"
                            placeholder="Añadir notas clínicas, antecedentes relevantes u otras observaciones..."
                            oninput="actualizarContador(this)"></textarea>

                        <span id="contador-obs" class="char-counter">0/250</span>
                    </div>
                </div>

                <hr style="margin: 2rem 0;">
                <div th:each="dato, stat : *{datosCrfList}" class="form-group">

                    <label th:for="${'valor-' + stat.index}" th:text="${dato.campoCrf.nombre}"></label>
                    <small th:if="${dato.campoCrf.descripcion != null}" th:text="${dato.campoCrf.descripcion}"
                        style="display: block; color: var(--color-texto-secundario); margin-bottom: 0.5rem;"></small>

                    <div th:switch="${dato.campoCrf.tipo}">

                        <input th:case="'NUMERO'" type="number" step="any" inputmode="decimal" class="form-control"
                            th:id="${'valor-' + stat.index}" th:field="*{datosCrfList[__${stat.index}__].valor}">

                        <input th:case="'FECHA'" type="date" class="form-control" th:id="${'valor-' + stat.index}"
                            th:field="*{datosCrfList[__${stat.index}__].valor}">

                        <div th:case="'SI/NO'" class="radio-group-sino">
                            <label class="radio-label">
                                <input type="radio" th:name="${'datosCrfList[' + stat.index + '].valor'}" value="1"
                                    th:checked="${#strings.equals(dato.valor, '1')}" class="radio-deselect" />
                                <span>Sí</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" th:name="${'datosCrfList[' + stat.index + '].valor'}" value="0"
                                    th:checked="${#strings.equals(dato.valor, '0')}" class="radio-deselect" />
                                <span>No</span>
                            </label>
                        </div>

                        <div th:case="'SELECCION_UNICA'" class="radio-group-sino">
                            <label th:each="opcion : ${dato.campoCrf.opciones}" class="radio-label">
                                <input type="radio" th:name="${'datosCrfList[' + stat.index + '].valor'}"
                                    th:value="${opcion.orden}"
                                    th:checked="${#strings.equals(dato.valor, #strings.toString(opcion.orden))}"
                                    class="radio-deselect" />
                                <span th:text="${opcion.etiqueta}"></span>
                            </label>
                        </div>

                        <input th:case="*" type="text" maxlength="30" class="form-control"
                            th:id="${'valor-' + stat.index}" th:field="*{datosCrfList[__${stat.index}__].valor}">
                    </div>

                    <input type="hidden" th:field="*{datosCrfList[__${stat.index}__].campoCrf.idCampo}" />
                </div>
            </div>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
            <button type="button" class="btn-primario" onclick="abrirConfirmacion()">Guardar CRF Completo</button>
            <a th:href="@{/inicio}" class="btn-secundario">Cancelar</a>
        </div>

        <div th:if="${errorMessage}" class="alert alert-error" style="margin-top: 1.5rem;">
            <strong>Error:</strong> <span th:text="${errorMessage}"></span>
        </div>

    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const requiredInputs = document.querySelectorAll('input[required], select[required], textarea[required]');

            requiredInputs.forEach(input => {
                input.addEventListener('invalid', function (e) {
                    this.classList.remove('input-error-anim');
                    void this.offsetWidth;
                    this.classList.add('input-error-anim');
                    setTimeout(() => {
                        this.classList.remove('input-error-anim');
                    }, 4000);
                });
            });
        });

        const modalConf = document.getElementById('modalConfirmarGuardado');

        const formCrf = document.getElementById('crfFormulario');

        function abrirConfirmacion() {
            if (!formCrf.checkValidity()) {
                formCrf.reportValidity();
                return;
            }

            document.getElementById('preview-codigo').textContent = document.getElementById('codigoPaciente').value;
            document.getElementById('preview-nombre').textContent = document.getElementById('nombre').value;
            document.getElementById('preview-apellido').textContent = document.getElementById('apellido').value;
            document.getElementById('preview-numero').textContent = document.getElementById('numero').value || '-';
            document.getElementById('preview-obs').textContent = document.getElementById('observacion').value || 'Sin observaciones';

            const tipoRadio = document.querySelector('input[name="esCasoEstudio"]:checked');
            document.getElementById('preview-tipo').textContent = tipoRadio ? (tipoRadio.value === 'true' ? 'Caso Estudio' : 'Caso Control') : '-';

            const tbody = document.getElementById('preview-tabla-cuerpo');
            tbody.innerHTML = '';

            const inputsDinamicos = document.querySelectorAll('[name^="datosCrfList"]');
            const respuestasMap = new Map();

            inputsDinamicos.forEach(input => {
                const match = input.name.match(/datosCrfList\[(\d+)\]/);
                if (match) {
                    const index = match[1];
                    const formGroup = input.closest('.form-group');
                    const label = formGroup.querySelector('label').innerText;
                    let valor = '';

                    if (input.type === 'checkbox') {
                        if (!input.name.startsWith('_')) {
                            valor = input.checked ? 'SÍ' : 'NO';
                            respuestasMap.set(index, { label, valor });
                        }
                    } else if (input.type === 'radio') {
                        // Solo capturar si está seleccionado
                        if (input.checked) {
                            // Intentar obtener el texto del span hermano (la etiqueta visual)
                            const span = input.parentElement.querySelector('span');
                            valor = span ? span.innerText : input.value;
                            // Para SI/NO, mapeamos 1/0 a texto legible
                            if (valor === '1' && !span) valor = 'Sí';
                            if (valor === '0' && !span) valor = 'No';

                            respuestasMap.set(index, { label, valor });
                        }
                    } else {
                        valor = input.value;
                        if (!input.name.endsWith('.campoCrf.idCampo')) {
                            respuestasMap.set(index, { label, valor });
                        }
                    }
                }
            });

            respuestasMap.forEach((data) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--color-fondo)';
                const tdPregunta = document.createElement('td');
                tdPregunta.textContent = data.label;
                tdPregunta.style.fontWeight = '600';
                tdPregunta.style.padding = '0.5rem';
                const tdRespuesta = document.createElement('td');
                tdRespuesta.textContent = data.valor || '-';
                tdRespuesta.style.padding = '0.5rem';
                tr.appendChild(tdPregunta);
                tr.appendChild(tdRespuesta);
                tbody.appendChild(tr);
            });

            modalConf.style.display = 'block';
        }

        function cerrarModalConfirmacion() {
            modalConf.style.display = 'none';
        }

        function enviarFormularioReal() {
            // Ahora enviará el formulario correcto
            formCrf.submit();
        }

        window.onclick = function (event) {
            if (event.target == modalConf) cerrarModalConfirmacion();
        }

        function actualizarContador(textarea) {
            const maxLength = textarea.getAttribute("maxlength");
            const currentLength = textarea.value.length;
            const contador = document.getElementById("contador-obs");
            contador.textContent = `${currentLength}/${maxLength}`;
            if (currentLength >= maxLength) {
                contador.style.color = "var(--color-error)";
            } else {
                contador.style.color = "var(--color-texto-secundario)";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const obsTextarea = document.getElementById("observacion");
            if (obsTextarea) {
                actualizarContador(obsTextarea);
            }
        });
    </script>

</div>

</html>